<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacro ICFES - Matem√°ticas</title>

    <!-- Chart.js para gr√°ficos -->
    <script src="./chart.umd.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="./supabase-js@2"></script>

    <style>
        /* ============================================ */
        /* ESTILOS PROFESIONALES TIPO ICFES */
        /* ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ============================================ */
        /* MODAL OVERLAY */
        /* ============================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-contenido {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-contenido h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-contenido p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* ============================================ */
        /* FORMULARIOS */
        /* ============================================ */

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ============================================ */
        /* BOTONES */
        /* ============================================ */

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primario {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primario:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secundario {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secundario:hover {
            background: #e0e0e0;
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        /* ============================================ */
        /* MENSAJES */
        /* ============================================ */

        .mensaje-error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mensaje-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #1565c0;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mensaje-advertencia {
            background: #fff3cd;
            color: #856404;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* CONTENEDOR PRINCIPAL DEL TEST */
        /* ============================================ */

        .contenedor-test {
            background: white;
            width: 95%;
            max-width: 1200px;
            min-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
        }

        .header-test {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-test h1 {
            font-size: 1.5rem;
        }

        .info-estudiante {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .info-estudiante span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* INSTRUCCIONES */
        /* ============================================ */

        .contenedor-instrucciones {
            background: white;
            width: 95%;
            max-width: 900px;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .contenedor-instrucciones h1 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .contenedor-instrucciones h2 {
            color: #333;
            margin-bottom: 1.5rem;
        }

        .instrucciones-contenido {
            color: #555;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .instrucciones-contenido ul {
            list-style: none;
            padding-left: 0;
        }

        .instrucciones-contenido li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .instrucciones-contenido li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .competencias {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .competencias h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        /* ============================================ */
        /* BARRA DE PROGRESO */
        /* ============================================ */

        .progreso {
            padding: 1.5rem;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        .progreso-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #555;
        }

        .barra-progreso {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progreso-actual {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* ============================================ */
        /* PREGUNTA */
        /* ============================================ */

        .pregunta-contenedor {
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .pregunta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .numero-pregunta {
            font-size: 1.25rem;
            font-weight: bold;
            color: #667eea;
        }

        .etiqueta-competencia {
            background: #e8eaf6;
            color: #667eea;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .contexto {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            line-height: 1.8;
            color: #333;
        }

        .contenedor-grafico {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .contenedor-grafico canvas {
            max-height: 400px;
        }

        .contenedor-grafico table {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
        }

        .contenedor-grafico th {
            background: #667eea;
            color: white;
            padding: 12px;
            font-weight: 600;
            border: 1px solid #5568d3;
        }

        .contenedor-grafico td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .contenedor-grafico tr:nth-child(even) {
            background: #f9f9f9;
        }

        .grafico-svg {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .pregunta-texto {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        /* ============================================ */
        /* OPCIONES DE RESPUESTA */
        /* ============================================ */

        .opciones {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .opcion {
            display: flex;
            align-items: flex-start;
            padding: 1rem 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .opcion:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .opcion.seleccionada {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .opcion input[type="radio"] {
            display: none;
        }

        .letra-opcion {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #666;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .opcion.seleccionada .letra-opcion {
            background: #667eea;
            color: white;
        }

        .texto-opcion {
            flex: 1;
            line-height: 1.6;
            color: #333;
        }

        /* ============================================ */
        /* NAVEGACI√ìN */
        /* ============================================ */

        .navegacion {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .navegacion button {
            padding: 0.75rem 2rem;
        }

        /* ============================================ */
        /* MAPA DE PREGUNTAS */
        /* ============================================ */

        .mapa-preguntas {
            padding: 1.5rem 2rem;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .mapa-preguntas h4 {
            margin-bottom: 1rem;
            color: #555;
        }

        .mapa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .btn-mapa {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-mapa:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .btn-mapa.respondida {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .btn-mapa.actual {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .leyenda-mapa {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
        }

        .leyenda-mapa span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .indicador {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #e0e0e0;
        }

        .indicador.respondida {
            background: #4caf50;
            border-color: #4caf50;
        }

        .indicador.pendiente {
            background: white;
        }

        /* ============================================ */
        /* MODAL DE √âXITO */
        /* ============================================ */

        .exito-icono {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .modal-acciones {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-acciones button {
            flex: 1;
        }

        .resumen-respuestas {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .resumen-respuestas p {
            margin: 0.5rem 0;
        }

        /* ============================================ */
        /* RESPONSIVE */
        /* ============================================ */

        @media (max-width: 768px) {
            .header-test {
                flex-direction: column;
                align-items: flex-start;
            }

            .mapa-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }

            .navegacion {
                flex-direction: column;
            }

            .navegacion button {
                width: 100%;
            }

            .contenedor-instrucciones {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>

<!-- ============================================ -->
<!-- MODAL DE AUTENTICACI√ìN -->
<!-- ============================================ -->
<div id="modal-autenticacion" class="modal-overlay">
    <div class="modal-contenido">
        <h2>üéì Simulacro ICFES - Matem√°ticas</h2>
        <p>Ingresa tu n√∫mero de documento para acceder al test</p>

        <form id="form-autenticacion">
            <div class="form-group">
                <label for="documento">N√∫mero de Documento</label>
                <input
                        type="text"
                        id="documento"
                        placeholder="Ej: 1234567890"
                        required
                        pattern="[0-9]+"
                        title="Solo n√∫meros"
                        maxlength="15"
                >
            </div>
            <button type="submit" class="btn btn-primario">Ingresar</button>
        </form>

        <div id="error-autenticacion" class="mensaje-error" style="display:none;">
            <span>‚ùå</span>
            <span>Documento no encontrado. Contacta al administrador.</span>
        </div>

        <div id="loading-autenticacion" class="mensaje-loading" style="display:none;">
            <span>üîÑ</span>
            <span>Verificando documento...</span>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- PANTALLA DE INSTRUCCIONES -->
<!-- ============================================ -->
<div id="instrucciones" class="contenedor-instrucciones">
    <h1>¬°Bienvenido/a, <span id="nombre-estudiante"></span>!</h1>
    <h2>Instrucciones del Simulacro de Matem√°ticas</h2>

    <div class="instrucciones-contenido">
        <p><strong>Esta prueba contiene 20 preguntas de selecci√≥n m√∫ltiple con √∫nica respuesta.</strong></p>

        <ul>
            <li>Lee cuidadosamente cada pregunta y su contexto</li>
            <li>Algunas preguntas incluyen gr√°ficos, tablas o diagramas</li>
            <li>Selecciona UNA opci√≥n de respuesta (A, B, C o D)</li>
            <li>Puedes navegar entre preguntas usando los botones</li>
            <li>El mapa inferior te permite ir directamente a cualquier pregunta</li>
            <li>Todas las preguntas son obligatorias antes de finalizar</li>
            <li><strong>Una vez env√≠es tus respuestas, no podr√°s modificarlas</strong></li>
        </ul>

        <div class="competencias">
            <h3>üìä Competencias evaluadas:</h3>
            <ul>
                <li><strong>Interpretaci√≥n y representaci√≥n:</strong> Comprensi√≥n y transformaci√≥n de informaci√≥n en diferentes formatos</li>
                <li><strong>Formulaci√≥n y ejecuci√≥n:</strong> Planteamiento e implementaci√≥n de estrategias para resolver problemas</li>
                <li><strong>Argumentaci√≥n:</strong> Validaci√≥n de procedimientos y soluciones matem√°ticas</li>
            </ul>
        </div>
    </div>

    <button id="btn-comenzar" class="btn btn-primario">üöÄ Comenzar Simulacro</button>
</div>

<!-- ============================================ -->
<!-- CONTENEDOR PRINCIPAL DEL TEST -->
<!-- ============================================ -->
<div id="contenedor-test" class="contenedor-test">

    <!-- Header -->
    <div class="header-test">
        <h1>üìê Simulacro ICFES - Matem√°ticas</h1>
        <div class="info-estudiante">
            <span>üë§ <strong id="header-nombre"></strong></span>
            <span>üÜî <strong id="header-documento"></strong></span>
        </div>
    </div>

    <!-- Barra de progreso -->
    <div class="progreso">
        <div class="progreso-info">
            <span id="contador-preguntas">Pregunta 1 de 20</span>
            <span id="contador-respondidas">Respondidas: 0/20</span>
        </div>
        <div class="barra-progreso">
            <div class="progreso-actual" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Pregunta actual -->
    <div id="pregunta-actual" class="pregunta-contenedor">
        <!-- Se renderiza din√°micamente con JavaScript -->
    </div>

    <!-- Navegaci√≥n -->
    <div class="navegacion">
        <button id="btn-anterior" class="btn btn-secundario" disabled>‚Üê Anterior</button>
        <button id="btn-siguiente" class="btn btn-primario">Siguiente ‚Üí</button>
        <button id="btn-finalizar" class="btn btn-finalizar" style="display:none;">‚úì Finalizar Test</button>
    </div>

    <!-- Mapa de preguntas -->
    <div class="mapa-preguntas">
        <h4>Navegaci√≥n r√°pida:</h4>
        <div id="mapa-botones" class="mapa-grid">
            <!-- Botones 1-20 generados din√°micamente -->
        </div>
        <div class="leyenda-mapa">
            <span><span class="indicador respondida"></span> Respondida</span>
            <span><span class="indicador pendiente"></span> Pendiente</span>
        </div>
    </div>

</div>

<!-- ============================================ -->
<!-- MODAL DE CONFIRMACI√ìN -->
<!-- ============================================ -->
<div id="modal-confirmacion" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <h2>‚ö†Ô∏è ¬øFinalizar el simulacro?</h2>

        <div class="resumen-respuestas">
            <p>Has respondido <strong id="total-respondidas">0</strong> de <strong>20</strong> preguntas.</p>
            <div id="advertencia-pendientes" class="mensaje-advertencia" style="display:none;">
                <span>‚ö†Ô∏è</span>
                <span>Tienes <strong id="num-pendientes"></strong> preguntas sin responder. Todas las preguntas son obligatorias.</span>
            </div>
        </div>

        <p style="margin-top: 1rem;">Una vez env√≠es, no podr√°s modificar tus respuestas.</p>

        <div class="modal-acciones">
            <button id="btn-continuar" class="btn btn-secundario">‚Üê Revisar respuestas</button>
            <button id="btn-confirmar-envio" class="btn btn-finalizar">S√≠, enviar respuestas ‚Üí</button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE √âXITO -->
<!-- ============================================ -->
<div id="modal-exito" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <div class="exito-icono">‚úÖ</div>
        <h2>¬°Respuestas enviadas correctamente!</h2>
        <p>Gracias por completar el simulacro, <strong id="exito-nombre"></strong>.</p>
        <p>Tus resultados ser√°n procesados y estar√°n disponibles pr√≥ximamente.</p>
        <button class="btn btn-primario" onclick="location.reload()">Cerrar</button>
    </div>
</div>

<script>
    // ============================================
    // ‚öôÔ∏è CONFIGURACI√ìN DE SUPABASE
    // ============================================
    // üîß CONFIGURAR ESTAS VARIABLES CON TUS CREDENCIALES DE SUPABASE
    const SUPABASE_URL = 'https://ikutsomtkzccnuvdvpen.supabase.co';  // Ejemplo: 'https://abcdefgh.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdXRzb210a3pjY251dmR2cGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTUxODMsImV4cCI6MjA3NzU3MTE4M30.G95k132Zvf7bDlLHrLqGxjUzhT0Vmr70ZWsbsPF1PfY';  // Ejemplo: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'


    // Inicializar cliente de Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let estudianteActual = {
        documento: null,
        nombre: ''
    };

    let estadoTest = {
        preguntaActual: 0,
        respuestas: {},
        horaInicio: null
    };

    // ============================================
    // BANCO DE PREGUNTAS (20 preguntas)
    // ============================================
    const bancoPreguntas = [
        // ========== PREGUNTA 1 - F√ÅCIL ==========
        {
            numero: 1,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Medidas de tendencia central",
            dificultad: "facil",
            contexto: "En una empresa de tecnolog√≠a se registraron las edades de 7 empleados del equipo de desarrollo: 24, 26, 24, 28, 30, 24 y 32 a√±os.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la moda de las edades de los empleados?",
            opciones: {
                A: "24 a√±os",
                B: "26 a√±os",
                C: "27 a√±os",
                D: "28 a√±os"
            },
            respuesta_correcta: "A",
            justificacion: "La moda es el valor que m√°s se repite. En este caso, 24 aparece 3 veces, m√°s que cualquier otro valor."
        },

        // ========== PREGUNTA 2 - MEDIA ==========
        {
            numero: 2,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Proporciones",
            dificultad: "media",
            contexto: "Un agricultor tiene un terreno rectangular de 120 metros de largo y 80 metros de ancho. Decide dividirlo en parcelas cuadradas de igual tama√±o, siendo cada lado el mayor posible.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la medida del lado de cada parcela cuadrada?",
            opciones: {
                A: "10 metros",
                B: "20 metros",
                C: "30 metros",
                D: "40 metros"
            },
            respuesta_correcta: "D",
            justificacion: "Se debe hallar el MCD (m√°ximo com√∫n divisor) de 120 y 80, que es 40. Este es el lado mayor posible de las parcelas cuadradas."
        },

        // ========== PREGUNTA 3 - MEDIA CON GR√ÅFICO ==========
        {
            numero: 3,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Interpretaci√≥n de gr√°ficos",
            dificultad: "media",
            contexto: "Una cafeter√≠a registr√≥ las ventas de bebidas durante una semana. El siguiente gr√°fico muestra los resultados:",
            tiene_grafico: true,
            tipo_grafico: "barras",
            pregunta: "¬øQu√© porcentaje aproximado representan las ventas de caf√© con respecto al total de bebidas vendidas?",
            opciones: {
                A: "30%",
                B: "35%",
                C: "40%",
                D: "45%"
            },
            respuesta_correcta: "C",
            justificacion: "Caf√©: 120 unidades. Total: 120+90+60+30 = 300 unidades. Porcentaje: (120/300) √ó 100 = 40%"
        },

        // ========== PREGUNTA 4 - DIF√çCIL ==========
        {
            numero: 4,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Sistemas de ecuaciones",
            dificultad: "dificil",
            contexto: "En una tienda, 3 camisas y 2 pantalones cuestan $180.000, mientras que 2 camisas y 4 pantalones cuestan $240.000.",
            tiene_grafico: false,
            pregunta: "Si una persona compra 1 camisa y 1 pantal√≥n, ¬øcu√°nto pagar√°?",
            opciones: {
                A: "$60.000",
                B: "$70.000",
                C: "$75.000",
                D: "$80.000"
            },
            respuesta_correcta: "C",
            justificacion: "Sistema: 3C+2P=180000; 2C+4P=240000. Resolviendo: C=30000, P=45000. Total: 30000+45000=75000"
        },

        // ========== PREGUNTA 5 - MEDIA CON TABLA ==========
        {
            numero: 5,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - An√°lisis de datos",
            dificultad: "media",
            contexto: "Una universidad realiz√≥ una encuesta sobre el medio de transporte que utilizan los estudiantes para llegar al campus. Los resultados se muestran en la siguiente tabla:",
            tiene_grafico: true,
            tipo_grafico: "tabla",
            datos_tabla: {
                headers: ["Medio de transporte", "N√∫mero de estudiantes"],
                rows: [
                    ["Bus", "350"],
                    ["Bicicleta", "180"],
                    ["Carro particular", "120"],
                    ["A pie", "150"]
                ]
            },
            pregunta: "Si se elige un estudiante al azar, ¬øcu√°l es la probabilidad de que se transporte en bicicleta o a pie?",
            opciones: {
                A: "11/40",
                B: "33/100",
                C: "41/100",
                D: "47/100"
            },
            respuesta_correcta: "C",
            justificacion: "Bicicleta + A pie = 180 + 150 = 330. Total = 800. Probabilidad exacta = 330/800 = 33/80 = 0.4125. La aproximaci√≥n m√°s cercana entre las opciones es 41/100 (0.41)"
             },

        // ========== PREGUNTA 6 - F√ÅCIL ==========
        {
            numero: 6,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Per√≠metro",
            dificultad: "facil",
            contexto: "Un jard√≠n tiene forma de rect√°ngulo con dimensiones de 15 metros de largo y 8 metros de ancho. Se desea colocar una cerca alrededor de todo el per√≠metro.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntos metros de cerca se necesitan?",
            opciones: {
                A: "23 metros",
                B: "30 metros",
                C: "46 metros",
                D: "120 metros"
            },
            respuesta_correcta: "C",
            justificacion: "Per√≠metro = 2(largo + ancho) = 2(15 + 8) = 2(23) = 46 metros"
        },

        // ========== PREGUNTA 7 - MEDIA ==========
        {
            numero: 7,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Porcentajes y variaci√≥n",
            dificultad: "media",
            contexto: "El precio de un producto aument√≥ un 20% y luego disminuy√≥ un 20%. Si el precio original era de $50.000, ¬øcu√°l es el precio final?",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es el precio final del producto despu√©s de ambas variaciones?",
            opciones: {
                A: "$48.000",
                B: "$49.000",
                C: "$50.000",
                D: "$52.000"
            },
            respuesta_correcta: "A",
            justificacion: "Despu√©s del aumento: 50000 √ó 1.20 = 60000. Despu√©s de la disminuci√≥n: 60000 √ó 0.80 = 48000"
        },

        // ========== PREGUNTA 8 - MEDIA CON GR√ÅFICO ==========
        {
            numero: 8,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - √Åreas",
            dificultad: "media",
            contexto: "En un parque se construir√° una zona de juegos con forma de tri√°ngulo is√≥sceles. La base del tri√°ngulo mide 16 metros y la altura es de 12 metros.",
            tiene_grafico: true,
            tipo_grafico: "geometrico",
            pregunta: "¬øCu√°l es el √°rea de la zona de juegos?",
            opciones: {
                A: "84 m¬≤",
                B: "96 m¬≤",
                C: "112 m¬≤",
                D: "192 m¬≤"
            },
            respuesta_correcta: "B",
            justificacion: "√Årea del tri√°ngulo = (base √ó altura) / 2 = (16 √ó 12) / 2 = 192 / 2 = 96 m¬≤"
        },

        // ========== PREGUNTA 9 - DIF√çCIL ==========
        {
            numero: 9,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Funciones cuadr√°ticas",
            dificultad: "dificil",
            contexto: "Una pelota es lanzada verticalmente hacia arriba. Su altura h (en metros) en funci√≥n del tiempo t (en segundos) est√° dada por la ecuaci√≥n: h(t) = -5t¬≤ + 20t + 2",
            tiene_grafico: false,
            pregunta: "¬øEn qu√© momento la pelota alcanza su altura m√°xima?",
            opciones: {
                A: "t = 1 segundo",
                B: "t = 2 segundos",
                C: "t = 3 segundos",
                D: "t = 4 segundos"
            },
            respuesta_correcta: "B",
            justificacion: "En una par√°bola y = ax¬≤ + bx + c, el v√©rtice est√° en x = -b/2a. Aqu√≠: t = -20/(2√ó(-5)) = -20/(-10) = 2 segundos"
        },

        // ========== PREGUNTA 10 - MEDIA ==========
        {
            numero: 10,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Aleatorio",
            tema: "Probabilidad - Eventos independientes",
            dificultad: "media",
            contexto: "En una bolsa hay 5 bolas rojas, 3 bolas azules y 2 bolas verdes. Se extrae una bola al azar, se registra su color y se devuelve a la bolsa. Luego se extrae otra bola.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la probabilidad de que ambas bolas extra√≠das sean rojas?",
            opciones: {
                A: "1/4",
                B: "1/3",
                C: "1/2",
                D: "2/5"
            },
            respuesta_correcta: "A",
            justificacion: "P(roja) = 5/10 = 1/2. Como se devuelve la bola: P(ambas rojas) = (1/2) √ó (1/2) = 1/4"
        },

        // ========== PREGUNTA 11 - F√ÅCIL ==========
        {
            numero: 11,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Aritm√©tica - Operaciones b√°sicas",
            dificultad: "facil",
            contexto: "Un ciclista recorre 15 kil√≥metros en 45 minutos a velocidad constante.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la velocidad del ciclista en km/h?",
            opciones: {
                A: "15 km/h",
                B: "20 km/h",
                C: "25 km/h",
                D: "30 km/h"
            },
            respuesta_correcta: "B",
            justificacion: "45 minutos = 0.75 horas. Velocidad = distancia/tiempo = 15/0.75 = 20 km/h"
        },

        // ========== PREGUNTA 12 - MEDIA CON GR√ÅFICO ==========
        {
            numero: 12,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Gr√°ficos circulares",
            dificultad: "media",
            contexto: "Una encuesta sobre preferencias de g√©neros musicales en un colegio arroj√≥ los siguientes resultados: Pop 40%, Rock 25%, Reggaet√≥n 20%, Otros 15%. Se encuestaron 400 estudiantes.",
            tiene_grafico: true,
            tipo_grafico: "circular",
            pregunta: "¬øCu√°ntos estudiantes m√°s prefieren Pop que Reggaet√≥n?",
            opciones: {
                A: "60 estudiantes",
                B: "80 estudiantes",
                C: "100 estudiantes",
                D: "120 estudiantes"
            },
            respuesta_correcta: "B",
            justificacion: "Pop: 40% de 400 = 160 estudiantes. Reggaet√≥n: 20% de 400 = 80 estudiantes. Diferencia: 160 - 80 = 80"
        },

        // ========== PREGUNTA 13 - MEDIA ==========
        {
            numero: 13,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Volumen",
            dificultad: "media",
            contexto: "Un tanque de agua tiene forma de cilindro con un radio de 2 metros y una altura de 5 metros. (Use œÄ ‚âà 3.14)",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es aproximadamente la capacidad del tanque en metros c√∫bicos?",
            opciones: {
                A: "31.4 m¬≥",
                B: "41.8 m¬≥",
                C: "52.6 m¬≥",
                D: "62.8 m¬≥"
            },
            respuesta_correcta: "D",
            justificacion: "Volumen del cilindro = œÄ √ó r¬≤ √ó h = 3.14 √ó 2¬≤ √ó 5 = 3.14 √ó 4 √ó 5 = 62.8 m¬≥"
        },

        // ========== PREGUNTA 14 - DIF√çCIL CON GR√ÅFICO ==========
        {
            numero: 14,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Funciones lineales",
            dificultad: "dificil",
            contexto: "Una empresa de taxis cobra una tarifa base de $4.000 m√°s $1.500 por cada kil√≥metro recorrido. La siguiente gr√°fica muestra la relaci√≥n entre la distancia y el costo total.",
            tiene_grafico: true,
            tipo_grafico: "lineas",
            pregunta: "Si un pasajero pag√≥ $16.000, ¬øcu√°ntos kil√≥metros recorri√≥?",
            opciones: {
                A: "6 km",
                B: "7 km",
                C: "8 km",
                D: "9 km"
            },
            respuesta_correcta: "C",
            justificacion: "Ecuaci√≥n: Costo = 4000 + 1500k. Si Costo = 16000: 16000 = 4000 + 1500k ‚Üí 12000 = 1500k ‚Üí k = 8 km"
        },

        // ========== PREGUNTA 15 - MEDIA ==========
        {
            numero: 15,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Ecuaciones",
            dificultad: "media",
            contexto: "La edad de Juan es el triple de la edad de su hermana Mar√≠a. Si dentro de 5 a√±os, la suma de sus edades ser√° 46 a√±os.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la edad actual de Juan?",
            opciones: {
                A: "21 a√±os",
                B: "24 a√±os",
                C: "27 a√±os",
                D: "30 a√±os"
            },
            respuesta_correcta: "C",
            justificacion: "Sea x la edad de Mar√≠a. Juan tiene 3x. Ecuaci√≥n: (x+5) + (3x+5) = 46 ‚Üí 4x + 10 = 46 ‚Üí x = 9. Juan: 3(9) = 27 a√±os"
        },

        // ========== PREGUNTA 16 - F√ÅCIL ==========
        {
            numero: 16,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - √Ångulos",
            dificultad: "facil",
            contexto: "Dos √°ngulos son complementarios. Si uno de ellos mide 35¬∞, ¬øcu√°nto mide el otro √°ngulo?",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la medida del √°ngulo complementario?",
            opciones: {
                A: "45¬∞",
                B: "55¬∞",
                C: "65¬∞",
                D: "145¬∞"
            },
            respuesta_correcta: "B",
            justificacion: "Los √°ngulos complementarios suman 90¬∞. Por lo tanto: 90¬∞ - 35¬∞ = 55¬∞"
        },

        // ========== PREGUNTA 17 - MEDIA CON TABLA ==========
        {
            numero: 17,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Media aritm√©tica",
            dificultad: "media",
            contexto: "Un estudiante obtuvo las siguientes calificaciones en sus evaluaciones bimestrales:",
            tiene_grafico: true,
            tipo_grafico: "tabla",
            datos_tabla: {
                headers: ["Bimestre", "Calificaci√≥n"],
                rows: [
                    ["Primero", "3.8"],
                    ["Segundo", "4.2"],
                    ["Tercero", "3.6"],
                    ["Cuarto", "4.4"]
                ]
            },
            pregunta: "¬øCu√°l es el promedio de calificaciones del estudiante en el a√±o?",
            opciones: {
                A: "3.8",
                B: "3.9",
                C: "4.0",
                D: "4.1"
            },
            respuesta_correcta: "C",
            justificacion: "Promedio = (3.8 + 4.2 + 3.6 + 4.4) / 4 = 16.0 / 4 = 4.0"
        },

        // ========== PREGUNTA 18 - MEDIA ==========
        {
            numero: 18,
            competencia: "Argumentaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Teorema de Pit√°goras",
            dificultad: "media",
            contexto: "Una escalera de 10 metros de longitud se apoya contra una pared. La base de la escalera est√° a 6 metros de distancia de la pared.",
            tiene_grafico: false,
            pregunta: "¬øA qu√© altura de la pared llega la escalera?",
            opciones: {
                A: "4 metros",
                B: "6 metros",
                C: "8 metros",
                D: "12 metros"
            },
            respuesta_correcta: "C",
            justificacion: "Por Pit√°goras: a¬≤ + b¬≤ = c¬≤. Entonces: 6¬≤ + h¬≤ = 10¬≤ ‚Üí 36 + h¬≤ = 100 ‚Üí h¬≤ = 64 ‚Üí h = 8 metros"
        },

        // ========== PREGUNTA 19 - DIF√çCIL ==========
        {
            numero: 19,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Progresiones",
            dificultad: "dificil",
            contexto: "Una bacteria se reproduce duplic√°ndose cada hora. Si inicialmente hay 5 bacterias, ¬øcu√°ntas bacterias habr√° despu√©s de 6 horas?",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntas bacterias habr√° transcurridas 6 horas?",
            opciones: {
                A: "160 bacterias",
                B: "240 bacterias",
                C: "320 bacterias",
                D: "640 bacterias"
            },
            respuesta_correcta: "C",
            justificacion: "Progresi√≥n geom√©trica: N = N‚ÇÄ √ó 2‚Åø = 5 √ó 2‚Å∂ = 5 √ó 64 = 320 bacterias"
        },

        // ========== PREGUNTA 20 - MEDIA ==========
        {
            numero: 20,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Aleatorio",
            tema: "Probabilidad - Eventos",
            dificultad: "media",
            contexto: "En un grupo de 50 estudiantes, 30 practican f√∫tbol, 25 practican baloncesto y 10 practican ambos deportes.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntos estudiantes NO practican ninguno de estos dos deportes?",
            opciones: {
                A: "5 estudiantes",
                B: "10 estudiantes",
                C: "15 estudiantes",
                D: "20 estudiantes"
            },
            respuesta_correcta: "A",
            justificacion: "Por inclusi√≥n-exclusi√≥n: F√∫tbol ‚à™ Baloncesto = 30 + 25 - 10 = 45. Ninguno = 50 - 45 = 5 estudiantes"
        }
    ];

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    document.getElementById('form-autenticacion').addEventListener('submit', async (e) => {
        e.preventDefault();

        const documento = parseInt(document.getElementById('documento').value.trim());
        const errorDiv = document.getElementById('error-autenticacion');
        const loadingDiv = document.getElementById('loading-autenticacion');

        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'flex';

        try {
            const { data, error } = await supabaseClient
                .from('estudiantes')
                .select('documento, nombre')
                .eq('documento', documento)
                .single();

            loadingDiv.style.display = 'none';

            if (error || !data) {
                errorDiv.style.display = 'flex';
                return;
            }

            estudianteActual.documento = data.documento;
            estudianteActual.nombre = data.nombre;

            document.getElementById('modal-autenticacion').style.display = 'none';
            document.getElementById('nombre-estudiante').textContent = estudianteActual.nombre;
            document.getElementById('instrucciones').style.display = 'flex';

        } catch (error) {
            console.error('Error al consultar Supabase:', error);
            loadingDiv.style.display = 'none';
            errorDiv.innerHTML = '<span>‚ùå</span><span>Error de conexi√≥n. Intenta nuevamente.</span>';
            errorDiv.style.display = 'flex';
        }
    });

    // ============================================
    // INICIAR TEST
    // ============================================
    document.getElementById('btn-comenzar').addEventListener('click', () => {
        estadoTest.horaInicio = new Date();

        document.getElementById('header-nombre').textContent = estudianteActual.nombre;
        document.getElementById('header-documento').textContent = estudianteActual.documento;

        document.getElementById('instrucciones').style.display = 'none';
        document.getElementById('contenedor-test').style.display = 'block';

        generarMapaPreguntas();
        renderizarPregunta(0);
    });

    // ============================================
    // RENDERIZAR PREGUNTA
    // ============================================
    function renderizarPregunta(index) {
        const pregunta = bancoPreguntas[index];
        const contenedor = document.getElementById('pregunta-actual');

        let htmlGrafico = '';
        if (pregunta.tiene_grafico) {
            if (pregunta.tipo_grafico === 'tabla') {
                htmlGrafico = generarTabla(pregunta.datos_tabla);
            } else {
                htmlGrafico = `<div class="contenedor-grafico">
            <canvas id="grafico-pregunta-${pregunta.numero}"></canvas>
          </div>`;
            }
        }

        contenedor.innerHTML = `
        <div class="pregunta-header">
          <span class="numero-pregunta">Pregunta ${pregunta.numero}</span>
          <span class="etiqueta-competencia">${pregunta.competencia}</span>
        </div>

        <div class="contexto">${pregunta.contexto}</div>

        ${htmlGrafico}

        <div class="pregunta-texto">${pregunta.pregunta}</div>

        <div class="opciones">
          ${Object.entries(pregunta.opciones).map(([letra, texto]) => `
            <label class="opcion ${estadoTest.respuestas[pregunta.numero] === letra ? 'seleccionada' : ''}">
              <input
                type="radio"
                name="respuesta-${pregunta.numero}"
                value="${letra}"
                ${estadoTest.respuestas[pregunta.numero] === letra ? 'checked' : ''}
              >
              <span class="letra-opcion">${letra}</span>
              <span class="texto-opcion">${texto}</span>
            </label>
          `).join('')}
        </div>
      `;

        if (pregunta.tiene_grafico && pregunta.tipo_grafico !== 'tabla') {
            setTimeout(() => renderizarGrafico(pregunta), 100);
        }

        document.querySelectorAll(`input[name="respuesta-${pregunta.numero}"]`).forEach(input => {
            input.addEventListener('change', (e) => {
                estadoTest.respuestas[pregunta.numero] = e.target.value;

                document.querySelectorAll('.opcion').forEach(op => op.classList.remove('seleccionada'));
                e.target.closest('.opcion').classList.add('seleccionada');

                actualizarEstado();
            });
        });

        actualizarNavegacion(index);
        actualizarEstado();
    }

    // ============================================
    // GENERAR TABLA HTML
    // ============================================
    function generarTabla(datos) {
        return `
        <div class="contenedor-grafico">
          <table>
            <thead>
              <tr>
                ${datos.headers.map(h => `<th>${h}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${datos.rows.map(row => `
                <tr>
                  ${row.map(cell => `<td>${cell}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // ============================================
    // RENDERIZAR GR√ÅFICOS (Chart.js)
    // ============================================
    function renderizarGrafico(pregunta) {
        const ctx = document.getElementById(`grafico-pregunta-${pregunta.numero}`);
        if (!ctx) return;

        // Configuraciones espec√≠ficas por pregunta
        let config = {};

        if (pregunta.numero === 3) {
            // Gr√°fico de barras - Ventas de cafeter√≠a
            config = {
                type: 'bar',
                data: {
                    labels: ['Caf√©', 'Jugo', 'T√©', 'Chocolate'],
                    datasets: [{
                        label: 'Unidades vendidas',
                        data: [120, 90, 60, 30],
                        backgroundColor: ['#8B4513', '#FFA500', '#90EE90', '#8B0000'],
                        borderColor: ['#654321', '#FF8C00', '#228B22', '#660000'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Ventas de bebidas en la semana',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Cantidad' }
                        },
                        x: {
                            title: { display: true, text: 'Tipo de bebida' }
                        }
                    }
                }
            };
        }

        if (pregunta.numero === 8) {
            // Tri√°ngulo is√≥sceles SVG
            ctx.parentElement.innerHTML = `
          <svg class="grafico-svg" width="300" height="250" viewBox="0 0 300 250">
            <defs>
              <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e0e0e0" stroke-width="0.5"/>
              </pattern>
            </defs>
            <rect width="300" height="250" fill="url(#grid)" />

            <!-- Tri√°ngulo -->
            <polygon points="50,220 250,220 150,60"
                     fill="#e3f2fd"
                     stroke="#1976d2"
                     stroke-width="3"/>

            <!-- Base -->
            <line x1="50" y1="220" x2="250" y2="220" stroke="#d32f2f" stroke-width="2"/>
            <text x="150" y="240" text-anchor="middle" font-size="14" fill="#d32f2f" font-weight="bold">16 m</text>

            <!-- Altura -->
            <line x1="150" y1="220" x2="150" y2="60" stroke="#388e3c" stroke-width="2" stroke-dasharray="5,5"/>
            <text x="165" y="140" font-size="14" fill="#388e3c" font-weight="bold">12 m</text>

            <!-- √Ångulo recto -->
            <rect x="145" y="215" width="10" height="10" fill="none" stroke="#666" stroke-width="1"/>
          </svg>
        `;
            return;
        }

        if (pregunta.numero === 12) {
            // Gr√°fico circular - G√©neros musicales
            config = {
                type: 'pie',
                data: {
                    labels: ['Pop', 'Rock', 'Reggaet√≥n', 'Otros'],
                    datasets: [{
                        data: [40, 25, 20, 15],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { font: { size: 12 }, padding: 15 }
                        },
                        title: {
                            display: true,
                            text: 'Preferencias de g√©neros musicales',
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            };
        }

        if (pregunta.numero === 14) {
            // Gr√°fico de l√≠neas - Tarifa de taxi
            config = {
                type: 'line',
                data: {
                    labels: ['0', '2', '4', '6', '8', '10'],
                    datasets: [{
                        label: 'Costo ($)',
                        data: [4000, 7000, 10000, 13000, 16000, 19000],
                        borderColor: '#FF6B6B',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#FF6B6B',
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'Costo del taxi seg√∫n distancia',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Costo (pesos)' },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            title: { display: true, text: 'Distancia (km)' }
                        }
                    }
                }
            };
        }

        if (Object.keys(config).length > 0) {
            new Chart(ctx.getContext('2d'), config);
        }
    }

    // ============================================
    // NAVEGACI√ìN
    // ============================================
    document.getElementById('btn-siguiente').addEventListener('click', () => {
        if (estadoTest.preguntaActual < bancoPreguntas.length - 1) {
            estadoTest.preguntaActual++;
            renderizarPregunta(estadoTest.preguntaActual);
        }
    });

    document.getElementById('btn-anterior').addEventListener('click', () => {
        if (estadoTest.preguntaActual > 0) {
            estadoTest.preguntaActual--;
            renderizarPregunta(estadoTest.preguntaActual);
        }
    });

    // ============================================
    // FINALIZAR TEST
    // ============================================
    document.getElementById('btn-finalizar').addEventListener('click', () => {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const pendientes = bancoPreguntas.length - respondidas;

        document.getElementById('total-respondidas').textContent = respondidas;

        const advertenciaDiv = document.getElementById('advertencia-pendientes');
        const btnConfirmar = document.getElementById('btn-confirmar-envio');

        if (pendientes > 0) {
            document.getElementById('num-pendientes').textContent = pendientes;
            advertenciaDiv.style.display = 'flex';
            btnConfirmar.disabled = true;
            btnConfirmar.style.opacity = '0.5';
            btnConfirmar.style.cursor = 'not-allowed';
        } else {
            advertenciaDiv.style.display = 'none';
            btnConfirmar.disabled = false;
            btnConfirmar.style.opacity = '1';
            btnConfirmar.style.cursor = 'pointer';
        }

        document.getElementById('modal-confirmacion').style.display = 'flex';
    });

    document.getElementById('btn-continuar').addEventListener('click', () => {
        document.getElementById('modal-confirmacion').style.display = 'none';
    });

    document.getElementById('btn-confirmar-envio').addEventListener('click', async () => {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        if (respondidas < bancoPreguntas.length) {
            alert('‚ö†Ô∏è Debes responder todas las preguntas antes de enviar.');
            return;
        }
        await enviarRespuestas();
    });

    // ============================================
    // ENV√çO A SUPABASE
    // ============================================
    async function enviarRespuestas() {
        const objetoRespuestas = {};
        bancoPreguntas.forEach(pregunta => {
            objetoRespuestas[pregunta.numero] = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
        });

        const respuestasDetalladas = {};
        bancoPreguntas.forEach(pregunta => {
            const respuestaEstudiante = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
            const esCorrecta = respuestaEstudiante === pregunta.respuesta_correcta;

            respuestasDetalladas[pregunta.numero] = {
                respuesta: respuestaEstudiante,
                competencia: pregunta.competencia,
                componente: pregunta.componente,
                tema: pregunta.tema,
                acierto: esCorrecta,
                respuesta_correcta: pregunta.respuesta_correcta
            };
        });

        const registro = {
            documento_estudiante: estudianteActual.documento,
            respuestas: objetoRespuestas,
            respuestas_detalladas: respuestasDetalladas
        };

        try {
            const { data, error } = await supabaseClient
                .from('respuestas_estudiantes')
                .insert([registro]);

            if (error) throw error;

            document.getElementById('modal-confirmacion').style.display = 'none';
            document.getElementById('exito-nombre').textContent = estudianteActual.nombre;
            document.getElementById('modal-exito').style.display = 'flex';

        } catch (error) {
            console.error('Error al enviar respuestas:', error);
            alert('‚ùå Error al enviar respuestas. Por favor, intenta nuevamente.\n\n' + error.message);
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function actualizarEstado() {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const progreso = (respondidas / bancoPreguntas.length) * 100;

        document.getElementById('contador-preguntas').textContent =
            `Pregunta ${estadoTest.preguntaActual + 1} de ${bancoPreguntas.length}`;
        document.getElementById('contador-respondidas').textContent =
            `Respondidas: ${respondidas}/${bancoPreguntas.length}`;
        document.querySelector('.progreso-actual').style.width = `${progreso}%`;

        actualizarMapaPreguntas();
    }

    function generarMapaPreguntas() {
        const mapa = document.getElementById('mapa-botones');
        mapa.innerHTML = bancoPreguntas.map((p, i) =>
            `<button class="btn-mapa" data-index="${i}">${p.numero}</button>`
        ).join('');

        mapa.querySelectorAll('.btn-mapa').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                estadoTest.preguntaActual = index;
                renderizarPregunta(index);
            });
        });
    }

    function actualizarMapaPreguntas() {
        document.querySelectorAll('.btn-mapa').forEach((btn, i) => {
            const numeroPregunta = bancoPreguntas[i].numero;
            btn.classList.remove('respondida', 'actual');

            if (estadoTest.respuestas[numeroPregunta]) {
                btn.classList.add('respondida');
            }

            if (i === estadoTest.preguntaActual) {
                btn.classList.add('actual');
            }
        });
    }

    function actualizarNavegacion(index) {
        document.getElementById('btn-anterior').disabled = (index === 0);

        if (index === bancoPreguntas.length - 1) {
            document.getElementById('btn-siguiente').style.display = 'none';
            document.getElementById('btn-finalizar').style.display = 'inline-block';
        } else {
            document.getElementById('btn-siguiente').style.display = 'inline-block';
            document.getElementById('btn-finalizar').style.display = 'none';
        }
    }

</script>

</body>
</html>