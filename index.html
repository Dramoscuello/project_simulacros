<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacro ICFES - Matem√°ticas</title>

    <!-- Chart.js para gr√°ficos -->
    <script src="./chart.umd.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="./supabase-js@2"></script>

    <style>
        /* ============================================ */
        /* ESTILOS PROFESIONALES TIPO ICFES */
        /* ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ============================================ */
        /* MODAL OVERLAY */
        /* ============================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-contenido {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-contenido h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-contenido p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* ============================================ */
        /* FORMULARIOS */
        /* ============================================ */

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ============================================ */
        /* BOTONES */
        /* ============================================ */

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primario {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primario:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secundario {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secundario:hover {
            background: #e0e0e0;
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        /* ============================================ */
        /* MENSAJES */
        /* ============================================ */

        .mensaje-error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mensaje-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #1565c0;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* CONTENEDOR PRINCIPAL DEL TEST */
        /* ============================================ */

        .contenedor-test {
            background: white;
            width: 95%;
            max-width: 1200px;
            min-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
        }

        .header-test {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-test h1 {
            font-size: 1.5rem;
        }

        .info-estudiante {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .info-estudiante span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* INSTRUCCIONES */
        /* ============================================ */

        .contenedor-instrucciones {
            background: white;
            width: 95%;
            max-width: 900px;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .contenedor-instrucciones h1 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .contenedor-instrucciones h2 {
            color: #333;
            margin-bottom: 1.5rem;
        }

        .instrucciones-contenido {
            color: #555;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .instrucciones-contenido ul {
            list-style: none;
            padding-left: 0;
        }

        .instrucciones-contenido li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .instrucciones-contenido li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .competencias {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .competencias h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        /* ============================================ */
        /* BARRA DE PROGRESO */
        /* ============================================ */

        .progreso {
            padding: 1.5rem;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        .progreso-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #555;
        }

        .barra-progreso {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progreso-actual {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* ============================================ */
        /* PREGUNTA */
        /* ============================================ */

        .pregunta-contenedor {
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .pregunta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .numero-pregunta {
            font-size: 1.25rem;
            font-weight: bold;
            color: #667eea;
        }

        .etiqueta-competencia {
            background: #e8eaf6;
            color: #667eea;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .contexto {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            line-height: 1.8;
            color: #333;
        }

        .contenedor-grafico {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .contenedor-grafico canvas {
            max-height: 400px;
            max-width: 100%;
        }

        .contenedor-grafico svg {
            max-width: 100%;
            height: auto;
        }

        .contenedor-grafico table {
            width: 100%;
            border-collapse: collapse;
        }

        .contenedor-grafico th,
        .contenedor-grafico td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .contenedor-grafico th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .pregunta-texto {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        /* ============================================ */
        /* OPCIONES DE RESPUESTA */
        /* ============================================ */

        .opciones {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .opcion {
            display: flex;
            align-items: flex-start;
            padding: 1rem 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .opcion:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .opcion.seleccionada {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .opcion input[type="radio"] {
            display: none;
        }

        .letra-opcion {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #666;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .opcion.seleccionada .letra-opcion {
            background: #667eea;
            color: white;
        }

        .texto-opcion {
            flex: 1;
            line-height: 1.6;
            color: #333;
        }

        /* ============================================ */
        /* NAVEGACI√ìN */
        /* ============================================ */

        .navegacion {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .navegacion button {
            padding: 0.75rem 2rem;
        }

        /* ============================================ */
        /* MAPA DE PREGUNTAS */
        /* ============================================ */

        .mapa-preguntas {
            padding: 1.5rem 2rem;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .mapa-preguntas h4 {
            margin-bottom: 1rem;
            color: #555;
        }

        .mapa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .btn-mapa {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-mapa:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .btn-mapa.respondida {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .btn-mapa.actual {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .leyenda-mapa {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
        }

        .leyenda-mapa span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .indicador {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #e0e0e0;
        }

        .indicador.respondida {
            background: #4caf50;
            border-color: #4caf50;
        }

        .indicador.pendiente {
            background: white;
        }

        /* ============================================ */
        /* MODAL DE √âXITO */
        /* ============================================ */

        .exito-icono {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .modal-acciones {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-acciones button {
            flex: 1;
        }

        .resumen-respuestas {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .resumen-respuestas p {
            margin: 0.5rem 0;
        }

        /* ============================================ */
        /* RESPONSIVE */
        /* ============================================ */

        @media (max-width: 768px) {
            .header-test {
                flex-direction: column;
                align-items: flex-start;
            }

            .mapa-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }

            .navegacion {
                flex-direction: column;
            }

            .navegacion button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- ============================================ -->
<!-- MODAL DE AUTENTICACI√ìN -->
<!-- ============================================ -->
<div id="modal-autenticacion" class="modal-overlay">
    <div class="modal-contenido">
        <h2>üéì Simulacro ICFES - Matem√°ticas</h2>
        <p>Ingresa tu n√∫mero de documento para acceder al test</p>

        <form id="form-autenticacion">
            <div class="form-group">
                <label for="documento">N√∫mero de Documento</label>
                <input
                        type="text"
                        id="documento"
                        placeholder="Ej: 1234567890"
                        required
                        pattern="[0-9]+"
                        title="Solo n√∫meros"
                        maxlength="15"
                >
            </div>
            <button type="submit" class="btn btn-primario">Ingresar</button>
        </form>

        <div id="error-autenticacion" class="mensaje-error" style="display:none;">
            <span>‚ùå</span>
            <span>Documento no encontrado. Contacta al administrador.</span>
        </div>

        <div id="loading-autenticacion" class="mensaje-loading" style="display:none;">
            <span>üîÑ</span>
            <span>Verificando documento...</span>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- PANTALLA DE INSTRUCCIONES -->
<!-- ============================================ -->
<div id="instrucciones" class="contenedor-instrucciones">
    <h1>¬°Bienvenido/a, <span id="nombre-estudiante"></span>!</h1>
    <h2>Instrucciones del Simulacro de Matem√°ticas</h2>

    <div class="instrucciones-contenido">
        <p><strong>Esta prueba contiene 20 preguntas de selecci√≥n m√∫ltiple con √∫nica respuesta.</strong></p>

        <ul>
            <li>Lee cuidadosamente cada pregunta y su contexto</li>
            <li>Algunas preguntas incluyen gr√°ficos, tablas o diagramas</li>
            <li>Selecciona UNA opci√≥n de respuesta (A, B, C o D)</li>
            <li>Puedes navegar entre preguntas usando los botones</li>
            <li>El mapa inferior te permite ir directamente a cualquier pregunta</li>
            <li>Aseg√∫rate de responder todas las preguntas antes de finalizar</li>
            <li><strong>Una vez env√≠es tus respuestas, no podr√°s modificarlas</strong></li>
        </ul>

        <div class="competencias">
            <h3>üìä Competencias evaluadas:</h3>
            <ul>
                <li><strong>Interpretaci√≥n y representaci√≥n:</strong> Comprensi√≥n y transformaci√≥n de informaci√≥n matem√°tica</li>
                <li><strong>Formulaci√≥n y ejecuci√≥n:</strong> Planteamiento y resoluci√≥n de problemas</li>
                <li><strong>Argumentaci√≥n:</strong> Validaci√≥n de procedimientos y estrategias matem√°ticas</li>
            </ul>
        </div>
    </div>

    <button id="btn-comenzar" class="btn btn-primario">üöÄ Comenzar Simulacro</button>
</div>

<!-- ============================================ -->
<!-- CONTENEDOR PRINCIPAL DEL TEST -->
<!-- ============================================ -->
<div id="contenedor-test" class="contenedor-test">

    <!-- Header -->
    <div class="header-test">
        <h1>üìê Simulacro ICFES - Matem√°ticas</h1>
        <div class="info-estudiante">
            <span>üë§ <strong id="header-nombre"></strong></span>
            <span>üÜî <strong id="header-documento"></strong></span>
        </div>
    </div>

    <!-- Barra de progreso -->
    <div class="progreso">
        <div class="progreso-info">
            <span id="contador-preguntas">Pregunta 1 de 20</span>
            <span id="contador-respondidas">Respondidas: 0/20</span>
        </div>
        <div class="barra-progreso">
            <div class="progreso-actual" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Pregunta actual -->
    <div id="pregunta-actual" class="pregunta-contenedor">
        <!-- Se renderiza din√°micamente con JavaScript -->
    </div>

    <!-- Navegaci√≥n -->
    <div class="navegacion">
        <button id="btn-anterior" class="btn btn-secundario" disabled>‚Üê Anterior</button>
        <button id="btn-siguiente" class="btn btn-primario">Siguiente ‚Üí</button>
        <button id="btn-finalizar" class="btn btn-finalizar" style="display:none;">‚úì Finalizar Test</button>
    </div>

    <!-- Mapa de preguntas -->
    <div class="mapa-preguntas">
        <h4>Navegaci√≥n r√°pida:</h4>
        <div id="mapa-botones" class="mapa-grid">
            <!-- Botones 1-20 generados din√°micamente -->
        </div>
        <div class="leyenda-mapa">
            <span><span class="indicador respondida"></span> Respondida</span>
            <span><span class="indicador pendiente"></span> Pendiente</span>
        </div>
    </div>

</div>

<!-- ============================================ -->
<!-- MODAL DE CONFIRMACI√ìN -->
<!-- ============================================ -->
<div id="modal-confirmacion" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <h2>‚ö†Ô∏è ¬øFinalizar el simulacro?</h2>

        <div class="resumen-respuestas">
            <p>Has respondido <strong id="total-respondidas">0</strong> de <strong>20</strong> preguntas.</p>
            <p id="advertencia-pendientes" style="display:none; color: #d32f2f; font-weight: 600;">
                ‚ö†Ô∏è Tienes <strong id="num-pendientes"></strong> preguntas sin responder.
            </p>
        </div>

        <p style="margin-top: 1rem;">Debes responder todas las preguntas antes de enviar.</p>

        <div class="modal-acciones">
            <button id="btn-continuar" class="btn btn-secundario">‚Üê Revisar respuestas</button>
            <button id="btn-confirmar-envio" class="btn btn-finalizar">S√≠, enviar respuestas ‚Üí</button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE √âXITO -->
<!-- ============================================ -->
<div id="modal-exito" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <div class="exito-icono">‚úÖ</div>
        <h2>¬°Respuestas enviadas correctamente!</h2>
        <p>Gracias por completar el simulacro, <strong id="exito-nombre"></strong>.</p>
        <p>Tus resultados ser√°n procesados y estar√°n disponibles pr√≥ximamente.</p>
        <button class="btn btn-primario" onclick="location.reload()">Cerrar</button>
    </div>
</div>

<script>
    // ============================================
    // ‚öôÔ∏è CONFIGURACI√ìN DE SUPABASE
    // ============================================
    // IMPORTANTE: Reemplaza estos valores con tus credenciales de Supabase
    const SUPABASE_URL = 'https://ikutsomtkzccnuvdvpen.supabase.co';  // Ejemplo: 'https://abcdefgh.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdXRzb210a3pjY251dmR2cGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTUxODMsImV4cCI6MjA3NzU3MTE4M30.G95k132Zvf7bDlLHrLqGxjUzhT0Vmr70ZWsbsPF1PfY';  // Ejemplo: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'


    // Inicializar cliente de Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let estudianteActual = {
        documento: null,
        nombre: ''
    };

    let estadoTest = {
        preguntaActual: 0,
        respuestas: {},
        horaInicio: null
    };

    // ============================================
    // BANCO DE PREGUNTAS (20 preguntas)
    // ============================================
    const bancoPreguntas = [
        // PREGUNTA 1 - Interpretaci√≥n y representaci√≥n - Estad√≠stica
        {
            numero: 1,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - An√°lisis de datos",
            dificultad: "media",
            contexto: "Una empresa de tecnolog√≠a registr√≥ las ventas mensuales de sus productos durante el primer semestre del a√±o. Los datos muestran las cantidades vendidas de tres l√≠neas de productos diferentes: smartphones, tablets y laptops.",
            tiene_grafico: true,
            tipo_grafico: "barras",
            pregunta: "¬øEn qu√© mes se registr√≥ la mayor diferencia entre las ventas de smartphones y laptops?",
            opciones: {
                A: "Enero",
                B: "Marzo",
                C: "Abril",
                D: "Junio"
            },
            respuesta_correcta: "C",
            justificacion: "En abril, smartphones tuvo 280 unidades y laptops 120, resultando en una diferencia de 160 unidades."
        },

        // PREGUNTA 2 - Formulaci√≥n y ejecuci√≥n - √Ålgebra
        {
            numero: 2,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Ecuaciones lineales",
            dificultad: "media",
            contexto: "Un club deportivo cobra una membres√≠a anual de $180.000 m√°s $15.000 por cada clase grupal a la que se inscriba el socio. Otro club cobra $240.000 anuales con clases grupales ilimitadas.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntas clases grupales deber√≠a tomar un socio en el a√±o para que ambos clubes tengan el mismo costo?",
            opciones: {
                A: "3 clases",
                B: "4 clases",
                C: "5 clases",
                D: "6 clases"
            },
            respuesta_correcta: "B",
            justificacion: "Igualando las ecuaciones: 180000 + 15000x = 240000, se obtiene x = 4 clases."
        },

        // PREGUNTA 3 - Argumentaci√≥n - Geometr√≠a
        {
            numero: 3,
            competencia: "Argumentaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - √Åreas",
            dificultad: "alta",
            contexto: "Un arquitecto dise√±a un jard√≠n rectangular de 12 metros de largo por 8 metros de ancho. Dentro del jard√≠n quiere construir un camino de 1 metro de ancho que bordee todo el per√≠metro interior.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es el √°rea que quedar√° disponible para plantas despu√©s de construir el camino?",
            opciones: {
                A: "56 m¬≤",
                B: "60 m¬≤",
                C: "64 m¬≤",
                D: "68 m¬≤"
            },
            respuesta_correcta: "B",
            justificacion: "El √°rea interior ser√° (12-2)(8-2) = 10√ó6 = 60 m¬≤."
        },

        // PREGUNTA 4 - Interpretaci√≥n y representaci√≥n - Geometr√≠a con tabla
        {
            numero: 4,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Per√≠metros y √°reas",
            dificultad: "media",
            contexto: "Una f√°brica de cajas produce contenedores con diferentes dimensiones. En la tabla se muestran las medidas de tres modelos de cajas rectangulares y sus costos de producci√≥n.",
            tiene_grafico: true,
            tipo_grafico: "tabla",
            pregunta: "¬øQu√© modelo tiene el menor costo de producci√≥n por metro cuadrado de superficie?",
            opciones: {
                A: "Modelo A",
                B: "Modelo B",
                C: "Modelo C",
                D: "Todos tienen el mismo costo por m¬≤"
            },
            respuesta_correcta: "C",
            justificacion: "√Årea superficial: Modelo A = 13m¬≤ (6,538 $/m¬≤), Modelo B = 20.8m¬≤ (5,288 $/m¬≤), Modelo C = 31.5m¬≤ (4,603 $/m¬≤). El Modelo C tiene el menor costo por m¬≤."
        },

        // PREGUNTA 5 - Formulaci√≥n y ejecuci√≥n - Proporcionalidad
        {
            numero: 5,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Proporcionalidad - Porcentajes",
            dificultad: "media",
            contexto: "Una tienda ofrece un descuento del 20% en todos sus productos por aniversario. Adicionalmente, los clientes con tarjeta de fidelidad reciben un 15% de descuento adicional sobre el precio ya rebajado.",
            tiene_grafico: false,
            pregunta: "Si un art√≠culo costaba inicialmente $250.000, ¬øcu√°l es el precio final que pagar√° un cliente con tarjeta de fidelidad?",
            opciones: {
                A: "$170.000",
                B: "$162.500",
                C: "$175.000",
                D: "$212.500"
            },
            respuesta_correcta: "A",
            justificacion: "Primer descuento: 250000 √ó 0.8 = 200000. Segundo descuento: 200000 √ó 0.85 = 170000."
        },

        // PREGUNTA 6 - Argumentaci√≥n - Probabilidad
        {
            numero: 6,
            competencia: "Argumentaci√≥n",
            componente: "Aleatorio",
            tema: "Probabilidad - Eventos",
            dificultad: "alta",
            contexto: "En una bolsa hay 5 esferas rojas, 3 azules y 2 verdes. Se extrae una esfera al azar, se registra su color y se devuelve a la bolsa. Luego se extrae una segunda esfera.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la probabilidad de que ambas esferas extra√≠das sean del mismo color?",
            opciones: {
                A: "17/50",
                B: "19/50",
                C: "21/50",
                D: "23/50"
            },
            respuesta_correcta: "B",
            justificacion: "P(mismo color) = (5/10)¬≤ + (3/10)¬≤ + (2/10)¬≤ = 25/100 + 9/100 + 4/100 = 38/100 = 19/50."
        },

        // PREGUNTA 7 - Interpretaci√≥n y representaci√≥n - Gr√°fico circular
        {
            numero: 7,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Gr√°ficos",
            dificultad: "media",
            contexto: "Una encuesta realizada a 1.200 estudiantes sobre su deporte favorito arroj√≥ los siguientes resultados: F√∫tbol 35%, Baloncesto 25%, Voleibol 20%, Nataci√≥n 15%, Otros 5%.",
            tiene_grafico: true,
            tipo_grafico: "circular",
            pregunta: "¬øCu√°ntos estudiantes m√°s prefieren f√∫tbol que nataci√≥n?",
            opciones: {
                A: "180 estudiantes",
                B: "240 estudiantes",
                C: "300 estudiantes",
                D: "360 estudiantes"
            },
            respuesta_correcta: "B",
            justificacion: "F√∫tbol: 1200 √ó 0.35 = 420. Nataci√≥n: 1200 √ó 0.15 = 180. Diferencia: 420 - 180 = 240."
        },

        // PREGUNTA 8 - Formulaci√≥n y ejecuci√≥n - Funciones
        {
            numero: 8,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Funciones - Modelaci√≥n",
            dificultad: "alta",
            contexto: "La temperatura de un horno industrial aumenta seg√∫n la funci√≥n T(t) = 20 + 15t, donde T es la temperatura en grados Celsius y t es el tiempo en minutos desde que se enciende.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntos minutos deben transcurrir para que el horno alcance una temperatura de 245¬∞C?",
            opciones: {
                A: "12 minutos",
                B: "13 minutos",
                C: "14 minutos",
                D: "15 minutos"
            },
            respuesta_correcta: "D",
            justificacion: "245 = 20 + 15t ‚Üí 225 = 15t ‚Üí t = 15 minutos."
        },

        // PREGUNTA 9 - Argumentaci√≥n - Secuencias
        {
            numero: 9,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Sucesiones - Patrones",
            dificultad: "media",
            contexto: "Se observa la siguiente secuencia de n√∫meros: 2, 6, 12, 20, 30, ...",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la expresi√≥n general para el t√©rmino n de esta secuencia?",
            opciones: {
                A: "n¬≤ + n",
                B: "2n¬≤",
                C: "n(n + 1)",
                D: "2n(n + 1)"
            },
            respuesta_correcta: "C",
            justificacion: "La secuencia sigue el patr√≥n n(n+1): 1√ó2=2, 2√ó3=6, 3√ó4=12, 4√ó5=20, 5√ó6=30."
        },

        // PREGUNTA 10 - Interpretaci√≥n y representaci√≥n - Gr√°fico de l√≠neas
        {
            numero: 10,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Tendencias",
            dificultad: "media",
            contexto: "El siguiente gr√°fico muestra la evoluci√≥n del precio promedio del d√≥lar durante 6 meses. Se observa que inici√≥ en $3.800 en enero y termin√≥ en $4.200 en junio, con fluctuaciones intermedias.",
            tiene_grafico: true,
            tipo_grafico: "lineas",
            pregunta: "¬øEn qu√© mes se registr√≥ el mayor aumento del precio del d√≥lar respecto al mes anterior?",
            opciones: {
                A: "Febrero",
                B: "Marzo",
                C: "Abril",
                D: "Mayo"
            },
            respuesta_correcta: "D",
            justificacion: "En mayo, el precio aument√≥ de $3.900 a $4.100, representando un incremento de $200."
        },

        // PREGUNTA 11 - Formulaci√≥n y ejecuci√≥n - Sistemas de ecuaciones
        {
            numero: 11,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Sistemas de ecuaciones",
            dificultad: "alta",
            contexto: "En una cafeter√≠a, 2 caf√©s y 3 pasteles cuestan $23.000, mientras que 3 caf√©s y 2 pasteles cuestan $22.000.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es el precio de un caf√©?",
            opciones: {
                A: "$4.000",
                B: "$4.500",
                C: "$5.000",
                D: "$5.500"
            },
            respuesta_correcta: "A",
            justificacion: "Resolviendo el sistema: 2c + 3p = 23000 y 3c + 2p = 22000, se obtiene c = 4000."
        },

        // PREGUNTA 12 - Argumentaci√≥n - Geometr√≠a anal√≠tica
        {
            numero: 12,
            competencia: "Argumentaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a anal√≠tica - Distancias",
            dificultad: "media",
            contexto: "En un plano cartesiano se ubican tres puntos: A(2, 3), B(6, 3) y C(2, 7).",
            tiene_grafico: false,
            pregunta: "¬øQu√© tipo de tri√°ngulo forman estos tres puntos?",
            opciones: {
                A: "Equil√°tero",
                B: "Is√≥sceles rect√°ngulo",
                C: "Escaleno",
                D: "Is√≥sceles no rect√°ngulo"
            },
            respuesta_correcta: "B",
            justificacion: "AB = 4, AC = 4, BC = ‚àö32 ‚âà 5.66. Es is√≥sceles con √°ngulo recto en A."
        },

        // PREGUNTA 13 - Interpretaci√≥n y representaci√≥n - Tabla de frecuencias
        {
            numero: 13,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Medidas de tendencia central",
            dificultad: "media",
            contexto: "Se registraron las calificaciones de 40 estudiantes en un examen. Los resultados muestran que 8 obtuvieron 3.0, 12 obtuvieron 3.5, 15 obtuvieron 4.0 y 5 obtuvieron 4.5.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la calificaci√≥n promedio del grupo?",
            opciones: {
                A: "3.55",
                B: "3.60",
                C: "3.65",
                D: "3.71"
            },
            respuesta_correcta: "D",
            justificacion: "Promedio = (8√ó3.0 + 12√ó3.5 + 15√ó4.0 + 5√ó4.5) / 40 = (24 + 42 + 60 + 22.5) / 40 = 148.5 / 40 = 3.7125 ‚âà 3.71."
        },

        // PREGUNTA 14 - Formulaci√≥n y ejecuci√≥n - Optimizaci√≥n
        {
            numero: 14,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Optimizaci√≥n - M√°ximos y m√≠nimos",
            dificultad: "alta",
            contexto: "Un granjero tiene 240 metros de cerca para construir un corral rectangular. Quiere aprovechar una pared existente como uno de los lados largos del corral, por lo que solo necesita cercar los otros tres lados (dos lados perpendiculares a la pared y un lado paralelo opuesto).",
            tiene_grafico: false,
            pregunta: "¬øCu√°les deben ser las dimensiones del corral para obtener el √°rea m√°xima? (ancho perpendicular a la pared √ó largo paralelo a la pared)",
            opciones: {
                A: "80 m √ó 80 m",
                B: "60 m √ó 120 m",
                C: "70 m √ó 100 m",
                D: "50 m √ó 140 m"
            },
            respuesta_correcta: "B",
            justificacion: "Sea x el ancho perpendicular a la pared. Per√≠metro: 2x + y = 240, entonces y = 240 - 2x. √Årea = xy = x(240-2x). Derivando e igualando a cero: x = 60m, y = 120m."
        },

        // PREGUNTA 15 - Argumentaci√≥n - L√≥gica matem√°tica
        {
            numero: 15,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "L√≥gica - Razonamiento",
            dificultad: "media",
            contexto: "Se afirma que 'Si un n√∫mero es divisible por 6, entonces es divisible por 3'. Mar√≠a dice que su n√∫mero es divisible por 3, por lo tanto concluye que es divisible por 6.",
            tiene_grafico: false,
            pregunta: "¬øEs correcta la conclusi√≥n de Mar√≠a?",
            opciones: {
                A: "S√≠, porque 6 y 3 son m√∫ltiplos",
                B: "No, porque est√° invirtiendo incorrectamente la implicaci√≥n",
                C: "S√≠, si el n√∫mero tambi√©n es par",
                D: "No, porque 3 no es factor de 6"
            },
            respuesta_correcta: "B",
            justificacion: "La conclusi√≥n es incorrecta. El n√∫mero 9 es divisible por 3 pero no por 6. Es un error de inversi√≥n l√≥gica."
        },

        // PREGUNTA 16 - Interpretaci√≥n y representaci√≥n - Geometr√≠a con SVG
        {
            numero: 16,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - C√≠rculos y sectores",
            dificultad: "media",
            contexto: "En una pizzer√≠a, una pizza grande tiene un di√°metro de 40 cm. Si se corta en 8 porciones iguales, cada porci√≥n representa un sector circular.",
            tiene_grafico: true,
            tipo_grafico: "geometrico",
            pregunta: "¬øCu√°l es el √°rea aproximada de cada porci√≥n? (Usar œÄ ‚âà 3.14)",
            opciones: {
                A: "157 cm¬≤",
                B: "175 cm¬≤",
                C: "188 cm¬≤",
                D: "200 cm¬≤"
            },
            respuesta_correcta: "A",
            justificacion: "√Årea total = œÄ √ó (20)¬≤ ‚âà 1256 cm¬≤. Cada porci√≥n = 1256/8 ‚âà 157 cm¬≤."
        },

        // PREGUNTA 17 - Formulaci√≥n y ejecuci√≥n - Tasas de cambio
        {
            numero: 17,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Funciones - Tasas de cambio",
            dificultad: "alta",
            contexto: "Un tanque de agua tiene una capacidad de 8.000 litros. Se llena a raz√≥n de 120 litros por minuto, pero simult√°neamente pierde agua por una fuga de 20 litros por minuto.",
            tiene_grafico: false,
            pregunta: "¬øCu√°nto tiempo tardar√° en llenarse completamente el tanque si inicialmente est√° vac√≠o?",
            opciones: {
                A: "60 minutos",
                B: "70 minutos",
                C: "80 minutos",
                D: "90 minutos"
            },
            respuesta_correcta: "C",
            justificacion: "Tasa neta = 120 - 20 = 100 litros/min. Tiempo = 8000/100 = 80 minutos."
        },

        // PREGUNTA 18 - Argumentaci√≥n - Trigonometr√≠a
        {
            numero: 18,
            competencia: "Argumentaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Trigonometr√≠a - Razones trigonom√©tricas",
            dificultad: "alta",
            contexto: "Desde la cima de un edificio de 60 metros de altura, el √°ngulo de depresi√≥n para observar un objeto en el suelo es de 30¬∞.",
            tiene_grafico: false,
            pregunta: "¬øA qu√© distancia horizontal del edificio se encuentra el objeto? (Usar ‚àö3 ‚âà 1.73)",
            opciones: {
                A: "90 metros",
                B: "100 metros",
                C: "104 metros",
                D: "110 metros"
            },
            respuesta_correcta: "C",
            justificacion: "tan(30¬∞) = 60/d ‚Üí d = 60/tan(30¬∞) = 60/(1/‚àö3) = 60‚àö3 ‚âà 104 metros."
        },

        // PREGUNTA 19 - Interpretaci√≥n y representaci√≥n - Combinatoria
        {
            numero: 19,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Combinatoria - Conteo",
            dificultad: "media",
            contexto: "Un restaurante ofrece un men√∫ del d√≠a donde el cliente puede escoger: 1 entrada (entre 3 opciones), 1 plato fuerte (entre 4 opciones) y 1 postre (entre 2 opciones).",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntas combinaciones diferentes de men√∫ puede elegir un cliente?",
            opciones: {
                A: "9 combinaciones",
                B: "12 combinaciones",
                C: "18 combinaciones",
                D: "24 combinaciones"
            },
            respuesta_correcta: "D",
            justificacion: "Total de combinaciones = 3 √ó 4 √ó 2 = 24 men√∫s diferentes."
        },

        // PREGUNTA 20 - Formulaci√≥n y ejecuci√≥n - Inter√©s compuesto
        {
            numero: 20,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Matem√°tica financiera - Inter√©s compuesto",
            dificultad: "alta",
            contexto: "Una persona invierte $5.000.000 en un fondo que paga una tasa de inter√©s del 8% anual compuesto. No realiza retiros ni dep√≥sitos adicionales durante 3 a√±os.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l ser√° aproximadamente el valor de su inversi√≥n al final de los 3 a√±os?",
            opciones: {
                A: "$6.200.000",
                B: "$6.298.560",
                C: "$6.400.000",
                D: "$6.500.000"
            },
            respuesta_correcta: "B",
            justificacion: "Monto = 5000000 √ó (1.08)¬≥ = 5000000 √ó 1.259712 ‚âà $6.298.560."
        }
    ];

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    document.getElementById('form-autenticacion').addEventListener('submit', async (e) => {
        e.preventDefault();

        const documento = parseInt(document.getElementById('documento').value.trim());
        const errorDiv = document.getElementById('error-autenticacion');
        const loadingDiv = document.getElementById('loading-autenticacion');

        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'flex';

        try {
            const { data, error } = await supabaseClient
                .from('estudiantes')
                .select('documento, nombre')
                .eq('documento', documento)
                .single();

            loadingDiv.style.display = 'none';

            if (error || !data) {
                errorDiv.style.display = 'flex';
                return;
            }

            estudianteActual.documento = data.documento;
            estudianteActual.nombre = data.nombre;

            document.getElementById('modal-autenticacion').style.display = 'none';
            document.getElementById('nombre-estudiante').textContent = estudianteActual.nombre;
            document.getElementById('instrucciones').style.display = 'flex';

        } catch (error) {
            console.error('Error al consultar Supabase:', error);
            loadingDiv.style.display = 'none';
            errorDiv.innerHTML = '<span>‚ùå</span><span>Error de conexi√≥n. Intenta nuevamente.</span>';
            errorDiv.style.display = 'flex';
        }
    });

    // ============================================
    // INICIAR TEST
    // ============================================
    document.getElementById('btn-comenzar').addEventListener('click', () => {
        estadoTest.horaInicio = new Date();

        document.getElementById('header-nombre').textContent = estudianteActual.nombre;
        document.getElementById('header-documento').textContent = estudianteActual.documento;

        document.getElementById('instrucciones').style.display = 'none';
        document.getElementById('contenedor-test').style.display = 'block';

        generarMapaPreguntas();
        renderizarPregunta(0);
    });

    // ============================================
    // RENDERIZAR PREGUNTA
    // ============================================
    function renderizarPregunta(index) {
        const pregunta = bancoPreguntas[index];
        const contenedor = document.getElementById('pregunta-actual');

        let htmlGrafico = '';
        if (pregunta.tiene_grafico) {
            if (pregunta.tipo_grafico === 'tabla') {
                htmlGrafico = generarTabla(pregunta);
            } else {
                htmlGrafico = `<div class="contenedor-grafico">
            <canvas id="grafico-pregunta-${pregunta.numero}"></canvas>
          </div>`;
            }
        }

        contenedor.innerHTML = `
        <div class="pregunta-header">
          <span class="numero-pregunta">Pregunta ${pregunta.numero}</span>
          <span class="etiqueta-competencia">${pregunta.competencia}</span>
        </div>

        <div class="contexto">${pregunta.contexto}</div>

        ${htmlGrafico}

        <div class="pregunta-texto">${pregunta.pregunta}</div>

        <div class="opciones">
          ${Object.entries(pregunta.opciones).map(([letra, texto]) => `
            <label class="opcion ${estadoTest.respuestas[pregunta.numero] === letra ? 'seleccionada' : ''}">
              <input
                type="radio"
                name="respuesta-${pregunta.numero}"
                value="${letra}"
                ${estadoTest.respuestas[pregunta.numero] === letra ? 'checked' : ''}
              >
              <span class="letra-opcion">${letra}</span>
              <span class="texto-opcion">${texto}</span>
            </label>
          `).join('')}
        </div>
      `;

        if (pregunta.tiene_grafico && pregunta.tipo_grafico !== 'tabla') {
            setTimeout(() => renderizarGrafico(pregunta), 100);
        }

        document.querySelectorAll(`input[name="respuesta-${pregunta.numero}"]`).forEach(input => {
            input.addEventListener('change', (e) => {
                estadoTest.respuestas[pregunta.numero] = e.target.value;

                document.querySelectorAll('.opcion').forEach(op => op.classList.remove('seleccionada'));
                e.target.closest('.opcion').classList.add('seleccionada');

                actualizarEstado();
            });
        });

        actualizarNavegacion(index);
        actualizarEstado();
    }

    // ============================================
    // GENERAR TABLA HTML
    // ============================================
    function generarTabla(pregunta) {
        if (pregunta.numero === 4) {
            return `
          <div class="contenedor-grafico">
            <table>
              <thead>
                <tr>
                  <th>Modelo</th>
                  <th>Largo (m)</th>
                  <th>Ancho (m)</th>
                  <th>Alto (m)</th>
                  <th>Costo ($)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>A</strong></td>
                  <td>2.0</td>
                  <td>1.5</td>
                  <td>1.0</td>
                  <td>85.000</td>
                </tr>
                <tr>
                  <td><strong>B</strong></td>
                  <td>2.5</td>
                  <td>2.0</td>
                  <td>1.2</td>
                  <td>110.000</td>
                </tr>
                <tr>
                  <td><strong>C</strong></td>
                  <td>3.0</td>
                  <td>2.5</td>
                  <td>1.5</td>
                  <td>145.000</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
        }
        return '';
    }

    // ============================================
    // RENDERIZAR GR√ÅFICOS
    // ============================================
    function renderizarGrafico(pregunta) {
        const ctx = document.getElementById(`grafico-pregunta-${pregunta.numero}`);
        if (!ctx) return;

        if (pregunta.numero === 1) {
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                    datasets: [
                        {
                            label: 'Smartphones',
                            data: [180, 220, 250, 280, 240, 300],
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Tablets',
                            data: [120, 140, 160, 180, 170, 190],
                            backgroundColor: '#764ba2'
                        },
                        {
                            label: 'Laptops',
                            data: [100, 110, 130, 120, 140, 150],
                            backgroundColor: '#f093fb'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Ventas Mensuales por Producto' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Unidades Vendidas' } }
                    }
                }
            });
        }

        if (pregunta.numero === 7) {
            new Chart(ctx.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['F√∫tbol', 'Baloncesto', 'Voleibol', 'Nataci√≥n', 'Otros'],
                    datasets: [{
                        data: [35, 25, 20, 15, 5],
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4caf50', '#ffc107']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Deportes Favoritos (%)' }
                    }
                }
            });
        }

        if (pregunta.numero === 10) {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio'],
                    datasets: [{
                        label: 'Precio USD (COP)',
                        data: [3800, 3850, 3900, 3900, 4100, 4200],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: 'Evoluci√≥n del Precio del D√≥lar' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 3700,
                            title: { display: true, text: 'Precio (COP)' }
                        }
                    }
                }
            });
        }

        if (pregunta.numero === 16) {
            const svg = `
          <svg width="300" height="300" style="max-width: 100%;">
            <circle cx="150" cy="150" r="120" fill="none" stroke="#667eea" stroke-width="3"/>
            <line x1="150" y1="150" x2="270" y2="150" stroke="#f5576c" stroke-width="2"/>
            <line x1="150" y1="150" x2="235" y2="65" stroke="#f5576c" stroke-width="2"/>
            <path d="M 270 150 A 120 120 0 0 0 235 65 L 150 150 Z" fill="rgba(102, 126, 234, 0.3)" stroke="#667eea" stroke-width="2"/>
            <text x="190" y="110" font-size="14" fill="#333">Una porci√≥n</text>
            <text x="200" y="160" font-size="14" fill="#f5576c">r = 20 cm</text>
          </svg>
        `;
            ctx.parentElement.innerHTML = svg;
        }
    }

    // ============================================
    // NAVEGACI√ìN
    // ============================================
    document.getElementById('btn-siguiente').addEventListener('click', () => {
        if (estadoTest.preguntaActual < bancoPreguntas.length - 1) {
            estadoTest.preguntaActual++;
            renderizarPregunta(estadoTest.preguntaActual);
        }
    });

    document.getElementById('btn-anterior').addEventListener('click', () => {
        if (estadoTest.preguntaActual > 0) {
            estadoTest.preguntaActual--;
            renderizarPregunta(estadoTest.preguntaActual);
        }
    });

    // ============================================
    // FINALIZAR TEST
    // ============================================
    document.getElementById('btn-finalizar').addEventListener('click', () => {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const pendientes = bancoPreguntas.length - respondidas;

        document.getElementById('total-respondidas').textContent = respondidas;

        if (pendientes > 0) {
            document.getElementById('num-pendientes').textContent = pendientes;
            document.getElementById('advertencia-pendientes').style.display = 'block';
            document.getElementById('btn-confirmar-envio').disabled = true;
            document.getElementById('btn-confirmar-envio').style.opacity = '0.5';
        } else {
            document.getElementById('advertencia-pendientes').style.display = 'none';
            document.getElementById('btn-confirmar-envio').disabled = false;
            document.getElementById('btn-confirmar-envio').style.opacity = '1';
        }

        document.getElementById('modal-confirmacion').style.display = 'flex';
    });

    document.getElementById('btn-continuar').addEventListener('click', () => {
        document.getElementById('modal-confirmacion').style.display = 'none';
    });

    document.getElementById('btn-confirmar-envio').addEventListener('click', async () => {
        const pendientes = bancoPreguntas.length - Object.keys(estadoTest.respuestas).length;
        if (pendientes > 0) {
            alert('‚ö†Ô∏è Debes responder todas las preguntas antes de enviar.');
            return;
        }
        await enviarRespuestas();
    });

    // ============================================
    // ENV√çO A SUPABASE
    // ============================================
    async function enviarRespuestas() {
        const objetoRespuestas = {};
        bancoPreguntas.forEach(pregunta => {
            objetoRespuestas[pregunta.numero] = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
        });

        const respuestasDetalladas = {};
        bancoPreguntas.forEach(pregunta => {
            const respuestaEstudiante = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
            const esCorrecta = respuestaEstudiante === pregunta.respuesta_correcta;

            respuestasDetalladas[pregunta.numero] = {
                respuesta: respuestaEstudiante,
                competencia: pregunta.competencia,
                componente: pregunta.componente,
                tema: pregunta.tema,
                acierto: esCorrecta,
                respuesta_correcta: pregunta.respuesta_correcta
            };
        });

        const registro = {
            documento_estudiante: estudianteActual.documento,
            respuestas: objetoRespuestas,
            respuestas_detalladas: respuestasDetalladas
        };

        try {
            const { data, error } = await supabaseClient
                .from('respuestas_estudiantes')
                .insert([registro]);

            if (error) throw error;

            document.getElementById('modal-confirmacion').style.display = 'none';
            document.getElementById('exito-nombre').textContent = estudianteActual.nombre;
            document.getElementById('modal-exito').style.display = 'flex';

        } catch (error) {
            console.error('Error al enviar respuestas:', error);
            alert('‚ùå Error al enviar respuestas. Por favor, intenta nuevamente.\n\n' + error.message);
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function actualizarEstado() {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const progreso = (respondidas / bancoPreguntas.length) * 100;

        document.getElementById('contador-preguntas').textContent =
            `Pregunta ${estadoTest.preguntaActual + 1} de ${bancoPreguntas.length}`;
        document.getElementById('contador-respondidas').textContent =
            `Respondidas: ${respondidas}/${bancoPreguntas.length}`;
        document.querySelector('.progreso-actual').style.width = `${progreso}%`;

        actualizarMapaPreguntas();
    }

    function generarMapaPreguntas() {
        const mapa = document.getElementById('mapa-botones');
        mapa.innerHTML = bancoPreguntas.map((p, i) =>
            `<button class="btn-mapa" data-index="${i}">${p.numero}</button>`
        ).join('');

        mapa.querySelectorAll('.btn-mapa').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                estadoTest.preguntaActual = index;
                renderizarPregunta(index);
            });
        });
    }

    function actualizarMapaPreguntas() {
        document.querySelectorAll('.btn-mapa').forEach((btn, i) => {
            const numeroPregunta = bancoPreguntas[i].numero;
            btn.classList.remove('respondida', 'actual');

            if (estadoTest.respuestas[numeroPregunta]) {
                btn.classList.add('respondida');
            }

            if (i === estadoTest.preguntaActual) {
                btn.classList.add('actual');
            }
        });
    }

    function actualizarNavegacion(index) {
        document.getElementById('btn-anterior').disabled = (index === 0);

        if (index === bancoPreguntas.length - 1) {
            document.getElementById('btn-siguiente').style.display = 'none';
            document.getElementById('btn-finalizar').style.display = 'inline-block';
        } else {
            document.getElementById('btn-siguiente').style.display = 'inline-block';
            document.getElementById('btn-finalizar').style.display = 'none';
        }
    }

</script>

</body>
</html>