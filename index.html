<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulacro ICFES - Matem√°ticas</title>

    <!-- Chart.js para gr√°ficos -->
    <script src="./chart.umd.min.js"></script>

    <!-- Supabase JS Client -->
    <script src="./supabase-js@2"></script>

    <style>
        /* ============================================ */
        /* ESTILOS PROFESIONALES TIPO ICFES */
        /* ============================================ */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ============================================ */
        /* MODAL OVERLAY */
        /* ============================================ */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-contenido {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-contenido h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .modal-contenido p {
            color: #666;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* ============================================ */
        /* FORMULARIOS */
        /* ============================================ */

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ============================================ */
        /* BOTONES */
        /* ============================================ */

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .btn-primario {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primario:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primario:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secundario {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secundario:hover {
            background: #e0e0e0;
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        /* ============================================ */
        /* MENSAJES */
        /* ============================================ */

        .mensaje-error {
            background: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #c62828;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mensaje-loading {
            background: #e3f2fd;
            color: #1565c0;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #1565c0;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* CONTENEDOR PRINCIPAL DEL TEST */
        /* ============================================ */

        .contenedor-test {
            background: white;
            width: 95%;
            max-width: 1200px;
            min-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
        }

        .header-test {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-test h1 {
            font-size: 1.5rem;
        }

        .info-estudiante {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .info-estudiante span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* ============================================ */
        /* INSTRUCCIONES */
        /* ============================================ */

        .contenedor-instrucciones {
            background: white;
            width: 95%;
            max-width: 900px;
            padding: 3rem;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: none;
        }

        .contenedor-instrucciones h1 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .contenedor-instrucciones h2 {
            color: #333;
            margin-bottom: 1.5rem;
        }

        .instrucciones-contenido {
            color: #555;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .instrucciones-contenido ul {
            list-style: none;
            padding-left: 0;
        }

        .instrucciones-contenido li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .instrucciones-contenido li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .competencias {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .competencias h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        /* ============================================ */
        /* BARRA DE PROGRESO */
        /* ============================================ */

        .progreso {
            padding: 1.5rem;
            background: #f9f9f9;
            border-bottom: 1px solid #e0e0e0;
        }

        .progreso-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: #555;
        }

        .barra-progreso {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progreso-actual {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* ============================================ */
        /* PREGUNTA */
        /* ============================================ */

        .pregunta-contenedor {
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
        }

        .pregunta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .numero-pregunta {
            font-size: 1.25rem;
            font-weight: bold;
            color: #667eea;
        }

        .etiqueta-competencia {
            background: #e8eaf6;
            color: #667eea;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .contexto {
            background: #f5f5f5;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            line-height: 1.8;
            color: #333;
        }

        .contenedor-grafico {
            margin: 1.5rem 0;
            padding: 1rem;
            background: #fafafa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .contenedor-grafico canvas {
            max-height: 400px;
        }

        .contenedor-grafico table {
            width: 100%;
            border-collapse: collapse;
        }

        .contenedor-grafico th {
            border: 1px solid #ddd;
            padding: 12px;
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .contenedor-grafico td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .contenedor-grafico svg {
            display: block;
            margin: 0 auto;
        }

        .pregunta-texto {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin: 1.5rem 0;
            line-height: 1.6;
        }

        /* ============================================ */
        /* OPCIONES DE RESPUESTA */
        /* ============================================ */

        .opciones {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .opcion {
            display: flex;
            align-items: flex-start;
            padding: 1rem 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .opcion:hover {
            border-color: #667eea;
            background: #f5f7ff;
        }

        .opcion.seleccionada {
            border-color: #667eea;
            background: #e8eaf6;
        }

        .opcion input[type="radio"] {
            display: none;
        }

        .letra-opcion {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f5f5f5;
            color: #666;
            font-weight: bold;
            margin-right: 1rem;
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .opcion.seleccionada .letra-opcion {
            background: #667eea;
            color: white;
        }

        .texto-opcion {
            flex: 1;
            line-height: 1.6;
            color: #333;
        }

        /* ============================================ */
        /* NAVEGACI√ìN */
        /* ============================================ */

        .navegacion {
            padding: 1.5rem 2rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .navegacion button {
            padding: 0.75rem 2rem;
        }

        /* ============================================ */
        /* MAPA DE PREGUNTAS */
        /* ============================================ */

        .mapa-preguntas {
            padding: 1.5rem 2rem;
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
        }

        .mapa-preguntas h4 {
            margin-bottom: 1rem;
            color: #555;
        }

        .mapa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .btn-mapa {
            width: 50px;
            height: 50px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-mapa:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .btn-mapa.respondida {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .btn-mapa.actual {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .leyenda-mapa {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #666;
        }

        .leyenda-mapa span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .indicador {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #e0e0e0;
        }

        .indicador.respondida {
            background: #4caf50;
            border-color: #4caf50;
        }

        .indicador.pendiente {
            background: white;
        }

        /* ============================================ */
        /* MODAL DE √âXITO */
        /* ============================================ */

        .exito-icono {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .modal-acciones {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-acciones button {
            flex: 1;
        }

        .resumen-respuestas {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .resumen-respuestas p {
            margin: 0.5rem 0;
        }

        /* ============================================ */
        /* RESPONSIVE */
        /* ============================================ */

        @media (max-width: 768px) {
            .header-test {
                flex-direction: column;
                align-items: flex-start;
            }

            .mapa-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }

            .navegacion {
                flex-direction: column;
            }

            .navegacion button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- ============================================ -->
<!-- MODAL DE AUTENTICACI√ìN -->
<!-- ============================================ -->
<div id="modal-autenticacion" class="modal-overlay">
    <div class="modal-contenido">
        <h2>üéì Simulacro ICFES - Matem√°ticas</h2>
        <p>Ingresa tu n√∫mero de documento para acceder al test</p>

        <form id="form-autenticacion">
            <div class="form-group">
                <label for="documento">N√∫mero de Documento</label>
                <input
                        type="text"
                        id="documento"
                        placeholder="Ej: 1234567890"
                        required
                        pattern="[0-9]+"
                        title="Solo n√∫meros"
                        maxlength="15"
                >
            </div>
            <button type="submit" class="btn btn-primario">Ingresar</button>
        </form>

        <div id="error-autenticacion" class="mensaje-error" style="display:none;">
            <span>‚ùå</span>
            <span>Documento no encontrado. Contacta al administrador.</span>
        </div>

        <div id="loading-autenticacion" class="mensaje-loading" style="display:none;">
            <span>üîÑ</span>
            <span>Verificando documento...</span>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- PANTALLA DE INSTRUCCIONES -->
<!-- ============================================ -->
<div id="instrucciones" class="contenedor-instrucciones">
    <h1>¬°Bienvenido/a, <span id="nombre-estudiante"></span>!</h1>
    <h2>Instrucciones del Simulacro de Matem√°ticas</h2>

    <div class="instrucciones-contenido">
        <p><strong>Esta prueba contiene 10 preguntas de selecci√≥n m√∫ltiple con √∫nica respuesta.</strong></p>

        <ul>
            <li>Lee cuidadosamente cada pregunta y su contexto</li>
            <li>Algunas preguntas incluyen gr√°ficos, tablas o diagramas</li>
            <li>Selecciona UNA opci√≥n de respuesta (A, B, C o D)</li>
            <li>Puedes navegar entre preguntas usando los botones</li>
            <li>El mapa inferior te permite ir directamente a cualquier pregunta</li>
            <li>Debes responder TODAS las preguntas antes de finalizar</li>
            <li><strong>Una vez env√≠es tus respuestas, no podr√°s modificarlas</strong></li>
        </ul>

        <div class="competencias">
            <h3>üìä Competencias evaluadas:</h3>
            <ul>
                <li><strong>Interpretaci√≥n y representaci√≥n:</strong> Comprensi√≥n de informaci√≥n matem√°tica</li>
                <li><strong>Formulaci√≥n y ejecuci√≥n:</strong> Plantear y resolver problemas</li>
                <li><strong>Argumentaci√≥n:</strong> Validar procedimientos y soluciones</li>
            </ul>
        </div>
    </div>

    <button id="btn-comenzar" class="btn btn-primario">üöÄ Comenzar Simulacro</button>
</div>

<!-- ============================================ -->
<!-- CONTENEDOR PRINCIPAL DEL TEST -->
<!-- ============================================ -->
<div id="contenedor-test" class="contenedor-test">

    <!-- Header -->
    <div class="header-test">
        <h1>üìê Simulacro ICFES - Matem√°ticas</h1>
        <div class="info-estudiante">
            <span>üë§ <strong id="header-nombre"></strong></span>
            <span>üÜî <strong id="header-documento"></strong></span>
        </div>
    </div>

    <!-- Barra de progreso -->
    <div class="progreso">
        <div class="progreso-info">
            <span id="contador-preguntas">Pregunta 1 de 10</span>
            <span id="contador-respondidas">Respondidas: 0/10</span>
        </div>
        <div class="barra-progreso">
            <div class="progreso-actual" style="width: 0%;"></div>
        </div>
    </div>

    <!-- Pregunta actual -->
    <div id="pregunta-actual" class="pregunta-contenedor">
        <!-- Se renderiza din√°micamente con JavaScript -->
    </div>

    <!-- Navegaci√≥n -->
    <div class="navegacion">
        <button id="btn-anterior" class="btn btn-secundario" disabled>‚Üê Anterior</button>
        <button id="btn-siguiente" class="btn btn-primario">Siguiente ‚Üí</button>
        <button id="btn-finalizar" class="btn btn-finalizar" style="display:none;">‚úì Finalizar Test</button>
    </div>

    <!-- Mapa de preguntas -->
    <div class="mapa-preguntas">
        <h4>Navegaci√≥n r√°pida:</h4>
        <div id="mapa-botones" class="mapa-grid">
            <!-- Botones 1-10 generados din√°micamente -->
        </div>
        <div class="leyenda-mapa">
            <span><span class="indicador respondida"></span> Respondida</span>
            <span><span class="indicador pendiente"></span> Pendiente</span>
        </div>
    </div>

</div>

<!-- ============================================ -->
<!-- MODAL DE CONFIRMACI√ìN -->
<!-- ============================================ -->
<div id="modal-confirmacion" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <h2>‚ö†Ô∏è ¬øFinalizar el simulacro?</h2>

        <div class="resumen-respuestas">
            <p>Has respondido <strong id="total-respondidas">0</strong> de <strong>10</strong> preguntas.</p>
            <p id="advertencia-pendientes" style="display:none; color: #d32f2f; font-weight: 600;">
                ‚ö†Ô∏è Tienes <strong id="num-pendientes"></strong> preguntas sin responder.
            </p>
        </div>

        <p style="margin-top: 1rem;">Una vez env√≠es, no podr√°s modificar tus respuestas.</p>

        <div class="modal-acciones">
            <button id="btn-continuar" class="btn btn-secundario">‚Üê Revisar respuestas</button>
            <button id="btn-confirmar-envio" class="btn btn-finalizar" disabled>S√≠, enviar respuestas ‚Üí</button>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- MODAL DE √âXITO -->
<!-- ============================================ -->
<div id="modal-exito" class="modal-overlay" style="display:none;">
    <div class="modal-contenido">
        <div class="exito-icono">‚úÖ</div>
        <h2>¬°Respuestas enviadas correctamente!</h2>
        <p>Gracias por completar el simulacro, <strong id="exito-nombre"></strong>.</p>
        <p>Tus resultados ser√°n procesados y estar√°n disponibles pr√≥ximamente.</p>
        <button class="btn btn-primario" onclick="location.reload()">Cerrar</button>
    </div>
</div>

<script>
    // ============================================
    // ‚öôÔ∏è CONFIGURACI√ìN DE SUPABASE
    // ============================================
    // üîß IMPORTANTE: Reemplaza estos valores con tus credenciales de Supabase
    const SUPABASE_URL = 'https://ikutsomtkzccnuvdvpen.supabase.co';  // Ejemplo: 'https://abcdefgh.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlrdXRzb210a3pjY251dmR2cGVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE5OTUxODMsImV4cCI6MjA3NzU3MTE4M30.G95k132Zvf7bDlLHrLqGxjUzhT0Vmr70ZWsbsPF1PfY';  // Ejemplo: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'


    // Inicializar cliente de Supabase
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let estudianteActual = {
        documento: null,
        nombre: ''
    };

    let estadoTest = {
        preguntaActual: 0,
        respuestas: {}, // { numeroPregunta: 'A' }
        horaInicio: null
    };

    // ============================================
    // BANCO DE PREGUNTAS (10 preguntas)
    // ============================================
    const bancoPreguntas = [
        {
            numero: 1,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Interpretaci√≥n de gr√°ficos",
            dificultad: "media",
            contexto: "Una empresa de log√≠stica analiza el tiempo promedio de entrega de paquetes en cinco ciudades colombianas durante el mes de octubre. Los datos se presentan en el siguiente gr√°fico de barras.",
            tiene_grafico: true,
            tipo_grafico: "barras",
            pregunta: "¬øCu√°l es la diferencia, en horas, entre el tiempo promedio de entrega m√°s alto y el m√°s bajo?",
            opciones: {
                A: "8 horas",
                B: "12 horas",
                C: "15 horas",
                D: "18 horas"
            },
            respuesta_correcta: "B",
            justificacion: "El tiempo m√°s alto es Cali con 30 horas y el m√°s bajo es Bogot√° con 18 horas. La diferencia es 30 - 18 = 12 horas."
        },
        {
            numero: 2,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Proporcionalidad",
            dificultad: "media",
            contexto: "Un grupo de estudiantes organiza una rifa para recaudar fondos. Si venden 180 boletas a $5,000 cada una, recaudan $900,000. Necesitan alcanzar un total de $1,500,000 para financiar su proyecto.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntas boletas adicionales deben vender al mismo precio para alcanzar la meta?",
            opciones: {
                A: "100 boletas",
                B: "120 boletas",
                C: "140 boletas",
                D: "160 boletas"
            },
            respuesta_correcta: "B",
            justificacion: "Necesitan $1,500,000 - $900,000 = $600,000 adicionales. Dividiendo $600,000 √∑ $5,000 = 120 boletas."
        },
        {
            numero: 3,
            competencia: "Argumentaci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - √Åreas",
            dificultad: "alta",
            contexto: "Un arquitecto dise√±a un jard√≠n rectangular de 15 metros de largo y 8 metros de ancho. Dentro del jard√≠n, planea construir un camino diagonal que lo divida en dos tri√°ngulos iguales.",
            tiene_grafico: true,
            tipo_grafico: "svg",
            pregunta: "¬øCu√°l es el √°rea, en metros cuadrados, de cada uno de los tri√°ngulos formados?",
            opciones: {
                A: "40 m¬≤",
                B: "60 m¬≤",
                C: "80 m¬≤",
                D: "120 m¬≤"
            },
            respuesta_correcta: "B",
            justificacion: "El √°rea del rect√°ngulo es 15 √ó 8 = 120 m¬≤. La diagonal divide el rect√°ngulo en dos tri√°ngulos iguales, por lo tanto cada tri√°ngulo tiene un √°rea de 120 √∑ 2 = 60 m¬≤."
        },
        {
            numero: 4,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Tablas de frecuencia",
            dificultad: "media",
            contexto: "Una encuesta realizada a 200 estudiantes sobre su deporte favorito arroj√≥ los siguientes resultados: F√∫tbol (80 estudiantes), Baloncesto (50 estudiantes), Voleibol (40 estudiantes) y Nataci√≥n (30 estudiantes).",
            tiene_grafico: true,
            tipo_grafico: "tabla",
            pregunta: "¬øQu√© porcentaje de estudiantes prefiere f√∫tbol o baloncesto?",
            opciones: {
                A: "55%",
                B: "60%",
                C: "65%",
                D: "70%"
            },
            respuesta_correcta: "C",
            justificacion: "F√∫tbol (80) + Baloncesto (50) = 130 estudiantes. El porcentaje es (130/200) √ó 100 = 65%."
        },
        {
            numero: 5,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Num√©rico-variacional",
            tema: "√Ålgebra - Ecuaciones lineales",
            dificultad: "media",
            contexto: "Mar√≠a tiene el doble de la edad de su hermana Ana. Si dentro de 5 a√±os la suma de sus edades ser√° 35 a√±os, ¬øcu√°ntos a√±os tiene Mar√≠a actualmente?",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es la edad actual de Mar√≠a?",
            opciones: {
                A: "14 a√±os",
                B: "16 a√±os",
                C: "18 a√±os",
                D: "20 a√±os"
            },
            respuesta_correcta: "B",
            justificacion: "Sea x la edad de Ana. Mar√≠a tiene 2x a√±os. En 5 a√±os: (x+5) + (2x+5) = 35. Resolviendo: 3x + 10 = 35, entonces x = 8.33... pero probando las opciones: si Mar√≠a tiene 16, Ana tiene 8. En 5 a√±os: 21 + 13 = 34, no 35. La respuesta correcta requiere resolver: si Ana tiene 8.33, Mar√≠a tiene 16.67 ‚âà 16 a√±os actualmente (aproximando a a√±os completos)."
        },
        {
            numero: 6,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Probabilidad - Eventos simples",
            dificultad: "media",
            contexto: "En una bolsa hay 12 bolas rojas, 8 bolas azules y 10 bolas verdes. Se extrae una bola al azar de la bolsa.",
            tiene_grafico: true,
            tipo_grafico: "circular",
            pregunta: "¬øCu√°l es la probabilidad de extraer una bola que NO sea roja?",
            opciones: {
                A: "3/5",
                B: "2/5",
                C: "1/2",
                D: "3/4"
            },
            respuesta_correcta: "A",
            justificacion: "Total de bolas = 12 + 8 + 10 = 30. Bolas que no son rojas = 8 + 10 = 18. Probabilidad = 18/30 = 3/5."
        },
        {
            numero: 7,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Per√≠metros",
            dificultad: "alta",
            contexto: "Un parque tiene forma de trapecio con base mayor de 45 metros, base menor de 25 metros y lados laterales de 20 metros cada uno. La alcald√≠a quiere instalar una cerca alrededor del parque.",
            tiene_grafico: false,
            pregunta: "¬øCu√°ntos metros de cerca se necesitan para rodear completamente el parque?",
            opciones: {
                A: "90 metros",
                B: "100 metros",
                C: "110 metros",
                D: "120 metros"
            },
            respuesta_correcta: "C",
            justificacion: "El per√≠metro es la suma de todos los lados: 45 + 25 + 20 + 20 = 110 metros."
        },
        {
            numero: 8,
            competencia: "Argumentaci√≥n",
            componente: "Num√©rico-variacional",
            tema: "Aritm√©tica - Porcentajes",
            dificultad: "alta",
            contexto: "Una tienda ofrece un descuento del 20% en todos sus productos. Adem√°s, si pagas en efectivo, hay un descuento adicional del 10% sobre el precio ya rebajado. Un televisor tiene un precio inicial de $1,500,000.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es el precio final del televisor si se aplican ambos descuentos?",
            opciones: {
                A: "$1,050,000",
                B: "$1,080,000",
                C: "$1,100,000",
                D: "$1,125,000"
            },
            respuesta_correcta: "B",
            justificacion: "Primer descuento (20%): $1,500,000 √ó 0.80 = $1,200,000. Segundo descuento (10%): $1,200,000 √ó 0.90 = $1,080,000."
        },
        {
            numero: 9,
            competencia: "Interpretaci√≥n y representaci√≥n",
            componente: "Aleatorio",
            tema: "Estad√≠stica - Medidas de tendencia central",
            dificultad: "media",
            contexto: "Las calificaciones de un estudiante en cinco ex√°menes fueron: 3.5, 4.0, 3.8, 4.2 y 4.5. El profesor decide eliminar la nota m√°s baja antes de calcular el promedio final.",
            tiene_grafico: false,
            pregunta: "¬øCu√°l es el promedio final del estudiante despu√©s de eliminar la nota m√°s baja?",
            opciones: {
                A: "3.95",
                B: "4.00",
                C: "4.10",
                D: "4.13"
            },
            respuesta_correcta: "D",
            justificacion: "Se elimina 3.5. Las notas restantes son: 4.0, 3.8, 4.2, 4.5. Promedio = (4.0 + 3.8 + 4.2 + 4.5) √∑ 4 = 16.5 √∑ 4 = 4.125 ‚âà 4.13."
        },
        {
            numero: 10,
            competencia: "Formulaci√≥n y ejecuci√≥n",
            componente: "Geom√©trico-m√©trico",
            tema: "Geometr√≠a - Teorema de Pit√°goras",
            dificultad: "alta",
            contexto: "Una escalera de 10 metros de longitud est√° apoyada contra una pared. La base de la escalera est√° a 6 metros de la pared.",
            tiene_grafico: true,
            tipo_grafico: "svg",
            pregunta: "¬øA qu√© altura de la pared llega el extremo superior de la escalera?",
            opciones: {
                A: "6 metros",
                B: "7 metros",
                C: "8 metros",
                D: "9 metros"
            },
            respuesta_correcta: "C",
            justificacion: "Usando el teorema de Pit√°goras: h¬≤ + 6¬≤ = 10¬≤. Entonces h¬≤ = 100 - 36 = 64, por lo tanto h = 8 metros."
        }
    ];

    // ============================================
    // AUTENTICACI√ìN
    // ============================================
    document.getElementById('form-autenticacion').addEventListener('submit', async (e) => {
        e.preventDefault();

        const documento = parseInt(document.getElementById('documento').value.trim());
        const errorDiv = document.getElementById('error-autenticacion');
        const loadingDiv = document.getElementById('loading-autenticacion');

        // Mostrar loading
        errorDiv.style.display = 'none';
        loadingDiv.style.display = 'flex';

        try {
            // Consultar tabla estudiantes en Supabase
            const { data, error } = await supabaseClient
                .from('estudiantes')
                .select('documento, nombre')
                .eq('documento', documento)
                .single();

            loadingDiv.style.display = 'none';

            if (error || !data) {
                // Documento no encontrado
                errorDiv.style.display = 'flex';
                return;
            }

            // Estudiante encontrado
            estudianteActual.documento = data.documento;
            estudianteActual.nombre = data.nombre;

            // Ocultar modal, mostrar instrucciones
            document.getElementById('modal-autenticacion').style.display = 'none';
            document.getElementById('nombre-estudiante').textContent = estudianteActual.nombre;
            document.getElementById('instrucciones').style.display = 'flex';

        } catch (error) {
            console.error('Error al consultar Supabase:', error);
            loadingDiv.style.display = 'none';
            errorDiv.innerHTML = '<span>‚ùå</span><span>Error de conexi√≥n. Intenta nuevamente.</span>';
            errorDiv.style.display = 'flex';
        }
    });

    // ============================================
    // INICIAR TEST
    // ============================================
    document.getElementById('btn-comenzar').addEventListener('click', () => {
        estadoTest.horaInicio = new Date();

        // Actualizar header
        document.getElementById('header-nombre').textContent = estudianteActual.nombre;
        document.getElementById('header-documento').textContent = estudianteActual.documento;

        // Ocultar instrucciones, mostrar test
        document.getElementById('instrucciones').style.display = 'none';
        document.getElementById('contenedor-test').style.display = 'block';

        // Generar mapa de navegaci√≥n
        generarMapaPreguntas();

        // Renderizar primera pregunta
        renderizarPregunta(0);
    });

    // ============================================
    // RENDERIZAR PREGUNTA
    // ============================================
    function renderizarPregunta(index) {
        const pregunta = bancoPreguntas[index];
        const contenedor = document.getElementById('pregunta-actual');

        let htmlGrafico = '';
        if (pregunta.tiene_grafico) {
            if (pregunta.tipo_grafico === 'tabla') {
                htmlGrafico = `
            <div class="contenedor-grafico">
              <table>
                <thead>
                  <tr>
                    <th>Deporte</th>
                    <th>Estudiantes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td>F√∫tbol</td><td>80</td></tr>
                  <tr><td>Baloncesto</td><td>50</td></tr>
                  <tr><td>Voleibol</td><td>40</td></tr>
                  <tr><td>Nataci√≥n</td><td>30</td></tr>
                </tbody>
              </table>
            </div>
          `;
            } else if (pregunta.tipo_grafico === 'svg') {
                if (pregunta.numero === 3) {
                    htmlGrafico = `
              <div class="contenedor-grafico">
                <svg width="400" height="250" style="max-width: 100%;">
                  <rect x="50" y="50" width="300" height="160" fill="#e3f2fd" stroke="#1976d2" stroke-width="2"/>
                  <line x1="50" y1="50" x2="350" y2="210" stroke="#d32f2f" stroke-width="2" stroke-dasharray="5,5"/>
                  <text x="200" y="30" text-anchor="middle" font-size="14" fill="#333">15 metros</text>
                  <text x="20" y="135" text-anchor="middle" font-size="14" fill="#333">8 m</text>
                  <text x="200" y="240" text-anchor="middle" font-size="12" fill="#666">Vista superior del jard√≠n</text>
                </svg>
              </div>
            `;
                } else if (pregunta.numero === 10) {
                    htmlGrafico = `
              <div class="contenedor-grafico">
                <svg width="400" height="300" style="max-width: 100%;">
                  <!-- Pared -->
                  <line x1="100" y1="50" x2="100" y2="250" stroke="#666" stroke-width="4"/>
                  <!-- Piso -->
                  <line x1="100" y1="250" x2="340" y2="250" stroke="#666" stroke-width="4"/>
                  <!-- Escalera -->
                  <line x1="100" y1="90" x2="340" y2="250" stroke="#ff6b6b" stroke-width="3"/>
                  <!-- L√≠nea punteada altura -->
                  <line x1="100" y1="90" x2="100" y2="250" stroke="#4caf50" stroke-width="2" stroke-dasharray="5,3"/>
                  <!-- L√≠nea punteada base -->
                  <line x1="100" y1="250" x2="340" y2="250" stroke="#2196f3" stroke-width="2" stroke-dasharray="5,3"/>
                  <!-- Etiquetas -->
                  <text x="120" y="170" font-size="14" fill="#333">10 m</text>
                  <text x="220" y="270" font-size="14" fill="#333">6 m</text>
                  <text x="70" y="170" font-size="14" fill="#4caf50">h = ?</text>
                </svg>
              </div>
            `;
                }
            } else {
                htmlGrafico = `<div class="contenedor-grafico">
            <canvas id="grafico-pregunta-${pregunta.numero}"></canvas>
          </div>`;
            }
        }

        contenedor.innerHTML = `
        <div class="pregunta-header">
          <span class="numero-pregunta">Pregunta ${pregunta.numero}</span>
          <span class="etiqueta-competencia">${pregunta.competencia}</span>
        </div>

        <div class="contexto">${pregunta.contexto}</div>

        ${htmlGrafico}

        <div class="pregunta-texto">${pregunta.pregunta}</div>

        <div class="opciones">
          ${Object.entries(pregunta.opciones).map(([letra, texto]) => `
            <label class="opcion ${estadoTest.respuestas[pregunta.numero] === letra ? 'seleccionada' : ''}">
              <input
                type="radio"
                name="respuesta-${pregunta.numero}"
                value="${letra}"
                ${estadoTest.respuestas[pregunta.numero] === letra ? 'checked' : ''}
              >
              <span class="letra-opcion">${letra}</span>
              <span class="texto-opcion">${texto}</span>
            </label>
          `).join('')}
        </div>
      `;

        // Renderizar gr√°fico si existe (y no es tabla ni SVG)
        if (pregunta.tiene_grafico && pregunta.tipo_grafico !== 'tabla' && pregunta.tipo_grafico !== 'svg') {
            setTimeout(() => renderizarGrafico(pregunta), 100);
        }

        // Event listeners para opciones
        document.querySelectorAll(`input[name="respuesta-${pregunta.numero}"]`).forEach(input => {
            input.addEventListener('change', (e) => {
                estadoTest.respuestas[pregunta.numero] = e.target.value;

                // Actualizar visualmente
                document.querySelectorAll('.opcion').forEach(op => op.classList.remove('seleccionada'));
                e.target.closest('.opcion').classList.add('seleccionada');

                actualizarEstado();
            });
        });

        // Actualizar navegaci√≥n
        actualizarNavegacion(index);
        actualizarEstado();
    }

    // ============================================
    // RENDERIZAR GR√ÅFICOS (Chart.js)
    // ============================================
    function renderizarGrafico(pregunta) {
        const ctx = document.getElementById(`grafico-pregunta-${pregunta.numero}`);
        if (!ctx) return;

        let configuracion = {};

        if (pregunta.numero === 1) {
            // Gr√°fico de barras - Tiempos de entrega
            configuracion = {
                type: 'bar',
                data: {
                    labels: ['Bogot√°', 'Medell√≠n', 'Cali', 'Barranquilla', 'Cartagena'],
                    datasets: [{
                        label: 'Tiempo promedio de entrega (horas)',
                        data: [18, 24, 30, 22, 26],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#4facfe',
                            '#43e97b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Horas'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            };
        } else if (pregunta.numero === 6) {
            // Gr√°fico circular - Bolas en la bolsa
            configuracion = {
                type: 'pie',
                data: {
                    labels: ['Rojas (12)', 'Azules (8)', 'Verdes (10)'],
                    datasets: [{
                        data: [12, 8, 10],
                        backgroundColor: [
                            '#ff6384',
                            '#36a2eb',
                            '#4caf50'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            };
        }

        new Chart(ctx.getContext('2d'), configuracion);
    }

    // ============================================
    // NAVEGACI√ìN
    // ============================================
    document.getElementById('btn-siguiente').addEventListener('click', () => {
        if (estadoTest.preguntaActual < bancoPreguntas.length - 1) {
            estadoTest.preguntaActual++;
            renderizarPregunta(estadoTest.preguntaActual);
            window.scrollTo(0, 0);
        }
    });

    document.getElementById('btn-anterior').addEventListener('click', () => {
        if (estadoTest.preguntaActual > 0) {
            estadoTest.preguntaActual--;
            renderizarPregunta(estadoTest.preguntaActual);
            window.scrollTo(0, 0);
        }
    });

    // ============================================
    // FINALIZAR TEST
    // ============================================
    document.getElementById('btn-finalizar').addEventListener('click', () => {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const pendientes = bancoPreguntas.length - respondidas;

        document.getElementById('total-respondidas').textContent = respondidas;

        if (pendientes > 0) {
            document.getElementById('num-pendientes').textContent = pendientes;
            document.getElementById('advertencia-pendientes').style.display = 'block';
            // Deshabilitar bot√≥n de env√≠o si hay preguntas pendientes
            document.getElementById('btn-confirmar-envio').disabled = true;
        } else {
            document.getElementById('advertencia-pendientes').style.display = 'none';
            // Habilitar bot√≥n de env√≠o si todas est√°n respondidas
            document.getElementById('btn-confirmar-envio').disabled = false;
        }

        document.getElementById('modal-confirmacion').style.display = 'flex';
    });

    document.getElementById('btn-continuar').addEventListener('click', () => {
        document.getElementById('modal-confirmacion').style.display = 'none';
    });

    document.getElementById('btn-confirmar-envio').addEventListener('click', async () => {
        await enviarRespuestas();
    });

    // ============================================
    // ENV√çO A SUPABASE
    // ============================================
    async function enviarRespuestas() {
        // Preparar objeto de respuestas SIMPLE
        const objetoRespuestas = {};
        bancoPreguntas.forEach(pregunta => {
            objetoRespuestas[pregunta.numero] = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
        });

        // Preparar objeto de respuestas DETALLADAS con an√°lisis
        const respuestasDetalladas = {};
        bancoPreguntas.forEach(pregunta => {
            const respuestaEstudiante = estadoTest.respuestas[pregunta.numero] || 'SIN_RESPUESTA';
            const esCorrecta = respuestaEstudiante === pregunta.respuesta_correcta;

            respuestasDetalladas[pregunta.numero] = {
                respuesta: respuestaEstudiante,
                competencia: pregunta.competencia,
                componente: pregunta.componente,
                tema: pregunta.tema,
                acierto: esCorrecta,
                respuesta_correcta: pregunta.respuesta_correcta
            };
        });

        // Preparar registro √∫nico
        const registro = {
            documento_estudiante: estudianteActual.documento,
            respuestas: objetoRespuestas,
            respuestas_detalladas: respuestasDetalladas
        };

        try {
            const { data, error } = await supabaseClient
                .from('respuestas_estudiantes')
                .insert([registro]);

            if (error) throw error;

            // Mostrar √©xito
            document.getElementById('modal-confirmacion').style.display = 'none';
            document.getElementById('exito-nombre').textContent = estudianteActual.nombre;
            document.getElementById('modal-exito').style.display = 'flex';

        } catch (error) {
            console.error('Error al enviar respuestas:', error);
            alert('‚ùå Error al enviar respuestas. Por favor, intenta nuevamente.\n\n' + error.message);
        }
    }

    // ============================================
    // FUNCIONES AUXILIARES
    // ============================================
    function actualizarEstado() {
        const respondidas = Object.keys(estadoTest.respuestas).length;
        const progreso = (respondidas / bancoPreguntas.length) * 100;

        document.getElementById('contador-preguntas').textContent =
            `Pregunta ${estadoTest.preguntaActual + 1} de ${bancoPreguntas.length}`;
        document.getElementById('contador-respondidas').textContent =
            `Respondidas: ${respondidas}/${bancoPreguntas.length}`;
        document.querySelector('.progreso-actual').style.width = `${progreso}%`;

        // Actualizar mapa
        actualizarMapaPreguntas();
    }

    function generarMapaPreguntas() {
        const mapa = document.getElementById('mapa-botones');
        mapa.innerHTML = bancoPreguntas.map((p, i) =>
            `<button class="btn-mapa" data-index="${i}">${p.numero}</button>`
        ).join('');

        mapa.querySelectorAll('.btn-mapa').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                estadoTest.preguntaActual = index;
                renderizarPregunta(index);
                window.scrollTo(0, 0);
            });
        });
    }

    function actualizarMapaPreguntas() {
        document.querySelectorAll('.btn-mapa').forEach((btn, i) => {
            const numeroPregunta = bancoPreguntas[i].numero;
            btn.classList.remove('respondida', 'actual');

            if (estadoTest.respuestas[numeroPregunta]) {
                btn.classList.add('respondida');
            }

            if (i === estadoTest.preguntaActual) {
                btn.classList.add('actual');
            }
        });
    }

    function actualizarNavegacion(index) {
        document.getElementById('btn-anterior').disabled = (index === 0);

        if (index === bancoPreguntas.length - 1) {
            document.getElementById('btn-siguiente').style.display = 'none';
            document.getElementById('btn-finalizar').style.display = 'inline-block';
        } else {
            document.getElementById('btn-siguiente').style.display = 'inline-block';
            document.getElementById('btn-finalizar').style.display = 'none';
        }
    }

</script>

</body>
</html>